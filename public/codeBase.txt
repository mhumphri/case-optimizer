// SERVER

import express, { Request, Response } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { RouteOptimizationClient } from '@googlemaps/routeoptimization';

// ‚ö†Ô∏è CRITICAL: Load .env file FIRST before anything else!
dotenv.config();

const app = express();
app.use(express.json());
app.use(cors());

// üîç DEBUG: Check if environment variables are loaded
console.log('üîç Environment Check:');
console.log('   PROJECT_ID:', process.env.GOOGLE_CLOUD_PROJECT_ID);
console.log('   CREDENTIALS PATH:', process.env.GOOGLE_APPLICATION_CREDENTIALS);
console.log('   PORT:', process.env.PORT);

// Validate environment variables
if (!process.env.GOOGLE_CLOUD_PROJECT_ID) {
  console.error('‚ùå ERROR: GOOGLE_CLOUD_PROJECT_ID not found in .env file!');
  process.exit(1);
}

if (!process.env.GOOGLE_APPLICATION_CREDENTIALS) {
  console.error('‚ùå ERROR: GOOGLE_APPLICATION_CREDENTIALS not found in .env file!');
  process.exit(1);
}

// Initialize the client with your credentials
const client = new RouteOptimizationClient({
  keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,
});

// Optimize routes endpoint
app.post('/api/optimize-routes', async (req: Request, res: Response) => {
  try {
    const { model } = req.body;
    
    // ‚ö†Ô∏è IMPORTANT: Always use the project ID from .env, NOT from the request
    const projectId = process.env.GOOGLE_CLOUD_PROJECT_ID!;
    
    console.log('üìç Optimizing routes for project:', projectId);
    console.log('üì¶ Number of shipments:', model.shipments?.length);
    console.log('üöö Number of vehicles:', model.vehicles?.length);

    // Debug: Log first shipment to verify structure
    if (model.shipments && model.shipments.length > 0) {
      console.log('üìã Sample shipment received:', JSON.stringify(model.shipments[0], null, 2));
    }

    // Check if penalty costs are being used (for priority-based optimization)
    const hasPenaltyCosts = model.shipments?.some((s: any) => s.penaltyCost !== undefined);
    if (hasPenaltyCosts) {
      console.log('üí∞ Priority-based optimization enabled (using penalty costs)');
      const costs = model.shipments
        .map((s: any) => s.penaltyCost)
        .filter((c: any) => c !== undefined) as number[];
      const uniqueCosts = [...new Set(costs)].sort((a, b) => b - a);
      console.log('   Penalty cost levels:', uniqueCosts);
    }

    // Check for delivery time slots
    const hasTimeSlots = model.shipments?.some((s: any) => 
      s.deliveries?.[0]?.timeWindows?.[0]?.startTime?.seconds !== 32400 ||
      s.deliveries?.[0]?.timeWindows?.[0]?.endTime?.seconds !== 61200
    );
    if (hasTimeSlots) {
      const slotsCount = model.shipments.filter((s: any) => 
        s.deliveries?.[0]?.timeWindows?.[0]?.startTime?.seconds !== 32400
      ).length;
      console.log(`‚è∞ Delivery time slots detected: ${slotsCount} cases have specific time windows`);
    }

    // Call the Route Optimization API
    // The API natively supports:
    // - penaltyCost: Cost of NOT completing a shipment (higher = higher priority)
    // - The optimizer will prefer shipments with higher penalty costs
    // - This allows priority-based routing without custom modifications
    const [response] = await client.optimizeTours({
      parent: `projects/${projectId}`,
      model: {
        shipments: model.shipments,
        vehicles: model.vehicles,
      },
      searchMode: 'RETURN_FAST',
    });

    console.log('‚úÖ Optimization successful!');
    
    // Log skipped shipments if any (these are low-priority cases that couldn't fit)
    if (response.skippedShipments && response.skippedShipments.length > 0) {
      console.log('‚ö†Ô∏è  Skipped shipments:', response.skippedShipments.length);
    }
    
    res.json(response);
  } catch (error) {
    console.error('‚ùå Route optimization error:', error);
    res.status(500).json({
      error: 'Failed to optimize routes',
      details: error instanceof Error ? error.message : 'Unknown error',
    });
  }
});

// Health check endpoint
app.get('/api/health', (req: Request, res: Response) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    projectId: process.env.GOOGLE_CLOUD_PROJECT_ID,
  });
});

// Test environment variables endpoint
app.get('/api/debug', (req: Request, res: Response) => {
  res.json({
    envLoaded: !!process.env.GOOGLE_CLOUD_PROJECT_ID,
    projectId: process.env.GOOGLE_CLOUD_PROJECT_ID,
    credentialsPath: process.env.GOOGLE_APPLICATION_CREDENTIALS,
    port: process.env.PORT,
  });
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
  console.log('üöÄ Route Optimization server running');
  console.log(`üìç Port: ${PORT}`);
  console.log(`üîó Endpoint: http://localhost:${PORT}/api/optimize-routes`);
  console.log(`üîç Debug: http://localhost:${PORT}/api/debug`);
});

export default app;


// FRONTEND - components

import React from 'react';
import RouteOptimizer from './RouteOptimizer';

function App() {
  return <RouteOptimizer />;
}

export default App;

// RouteOptimizer.tsx - COMPLETE FILE with editable start location support
import React, { useState, useRef } from 'react';
import { useJsApiLoader } from '@react-google-maps/api';
import type { Location, OptimizedRoute, CaseData, CasePriority, CaseChange, TimeSlot, AgentSettings, AgentChange, ScenarioConfig, ScenarioType } from './types/route';
import { RouteMap } from './components/RouteMap';
import { RouteDetails } from './components/RouteDetails';
import { Header } from './components/Header';

// Scenario Definitions
const SCENARIOS: Record<ScenarioType, ScenarioConfig> = {
  full: {
    name: 'Full Scenario',
    description: '200 cases across 6 agents',
    caseCount: 200,
    agentPostcodes: ['W6 9LI', 'W2 3EL', 'SE12 4WH', 'E10 1PI', 'SE14 5NP', 'SW15 7GB'],
    defaultStartTime: '09:00',
    defaultEndTime: '17:00',
    defaultLunchDuration: 45,
    agentFinishPostcodes: ['SW1A 1AA', undefined, undefined, undefined, undefined, undefined],
  },
  reduced: {
    name: 'Reduced Scenario',
    description: '8 cases across 2 agents',
    caseCount: 10,
    agentPostcodes: ['W1A 1AA', 'SE14 5NP', 'SW1P 4DR'],
    defaultStartTime: '10:30',
    defaultEndTime: '14:00',
    defaultLunchDuration: 45,
    agentFinishPostcodes: ['EC1A 1BB', 'N1 9GU', 'W12 7GF'],
  },
};

const RouteOptimizer: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [optimizedRoutes, setOptimizedRoutes] = useState<OptimizedRoute[]>([]);
  const [error, setError] = useState('');
  const [agentLocations, setAgentLocations] = useState<Location[]>([]);
  const [cases, setCases] = useState<CaseData[]>([]);
  const [caseChanges, setCaseChanges] = useState<CaseChange[]>([]);
  const [agentSettings, setAgentSettings] = useState<AgentSettings[]>([]);
  const [agentChanges, setAgentChanges] = useState<AgentChange[]>([]);
  const [selectedScenario, setSelectedScenario] = useState<ScenarioType | null>(null);
  const [unallocatedCases, setUnallocatedCases] = useState<Array<CaseData & { unallocatedNumber: number }>>([]);
  const [routesVersion, setRoutesVersion] = useState(0);
  const [optimizedAgentSettings, setOptimizedAgentSettings] = useState<AgentSettings[]>([]);

  // Store original case data and agent settings for change tracking
  const originalCaseData = useRef<Map<string, { priority: CasePriority; deliverySlot?: TimeSlot }>>(new Map());
  const originalAgentSettings = useRef<AgentSettings[]>([]);
  const currentScenarioConfig = useRef<ScenarioConfig | null>(null);

  const googleMapsApiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;

  const { isLoaded, loadError } = useJsApiLoader({
    googleMapsApiKey: googleMapsApiKey || '',
  });

  const handlePriorityChange = (caseId: string, newPriority: CasePriority) => {
    const targetCase = cases.find(c => c.id === caseId);
    if (!targetCase) return;

    const currentPriority = targetCase.priority;

    if (currentPriority !== newPriority) {
      setCases(prevCases =>
        prevCases.map(c =>
          c.id === caseId ? { ...c, priority: newPriority } : c
        )
      );

      setCaseChanges(prev => {
        const originalData = originalCaseData.current.get(caseId);
        if (!originalData) return prev;

        const originalPriority = originalData.priority;
        const filteredChanges = prev.filter(change =>
          !(change.caseId === caseId && 'oldPriority' in change)
        );

        if (newPriority === originalPriority) {
          return filteredChanges;
        }

        return [
          ...filteredChanges,
          {
            caseId: targetCase.id,
            casePostcode: targetCase.postcode,
            oldPriority: originalPriority,
            newPriority,
            timestamp: new Date(),
          }
        ];
      });
    }
  };

  const handleSlotChange = (caseId: string, newSlot: TimeSlot | undefined) => {
    const targetCase = cases.find(c => c.id === caseId);
    if (!targetCase) return;

    setCases(prevCases =>
      prevCases.map(c =>
        c.id === caseId ? { ...c, deliverySlot: newSlot } : c
      )
    );

    setCaseChanges(prev => {
      const originalData = originalCaseData.current.get(caseId);
      if (!originalData) return prev;

      const originalSlot = originalData.deliverySlot;
      const filteredChanges = prev.filter(change =>
        !(change.caseId === caseId && 'oldSlot' in change)
      );

      const slotsEqual =
        (originalSlot === undefined && newSlot === undefined) ||
        (originalSlot && newSlot &&
          originalSlot.startTime === newSlot.startTime &&
          originalSlot.endTime === newSlot.endTime);

      if (slotsEqual) {
        return filteredChanges;
      }

      return [
        ...filteredChanges,
        {
          caseId: targetCase.id,
          casePostcode: targetCase.postcode,
          oldSlot: originalSlot,
          newSlot: newSlot,
          timestamp: new Date(),
        }
      ];
    });
  };

  const handleAgentSettingsChange = (agentIndex: number, newSettings: AgentSettings) => {
    if (newSettings.active && newSettings.startTime >= newSettings.endTime) {
      return;
    }

    setAgentSettings(prev => {
      const updated = [...prev];
      updated[agentIndex] = newSettings;
      return updated;
    });

    setAgentChanges(prev => {
      const originalSettings = originalAgentSettings.current[agentIndex];
      if (!originalSettings) return prev;

      const filteredChanges = prev.filter(change => change.agentIndex !== agentIndex);

      const settingsEqual =
        originalSettings.startTime === newSettings.startTime &&
        originalSettings.endTime === newSettings.endTime &&
        originalSettings.lunchDuration === newSettings.lunchDuration &&
        originalSettings.active === newSettings.active &&
        originalSettings.startPostcode === newSettings.startPostcode &&
        originalSettings.finishPostcode === newSettings.finishPostcode;

      if (settingsEqual) {
        return filteredChanges;
      }

      const route = optimizedRoutes[agentIndex];
      return [
        ...filteredChanges,
        {
          agentIndex,
          agentLabel: route?.vehicleLabel?.replace('Vehicle', 'Agent') || `Agent ${agentIndex + 1}`,
          oldSettings: originalSettings,
          newSettings,
          timestamp: new Date(),
        }
      ];
    });
  };

  const handleDeleteCaseChange = (caseId: string, changeType: 'priority' | 'slot') => {
    const originalData = originalCaseData.current.get(caseId);
    if (!originalData) return;

    if (changeType === 'priority') {
      setCases(prevCases =>
        prevCases.map(c =>
          c.id === caseId ? { ...c, priority: originalData.priority } : c
        )
      );

      setCaseChanges(prev =>
        prev.filter(change =>
          !(change.caseId === caseId && 'oldPriority' in change)
        )
      );
    } else {
      setCases(prevCases =>
        prevCases.map(c =>
          c.id === caseId ? { ...c, deliverySlot: originalData.deliverySlot } : c
        )
      );

      setCaseChanges(prev =>
        prev.filter(change =>
          !(change.caseId === caseId && 'oldSlot' in change)
        )
      );
    }
  };

  const handleDeleteAgentChange = (agentIndex: number) => {
    const originalSettings = originalAgentSettings.current[agentIndex];
    if (!originalSettings) return;

    setAgentSettings(prev => {
      const updated = [...prev];
      updated[agentIndex] = originalSettings;
      return updated;
    });

    setAgentChanges(prev => prev.filter(change => change.agentIndex !== agentIndex));
  };

  const handleRecalculate = async () => {
    try {
      await optimizeRoutes(cases, agentSettings);
      setCaseChanges([]);
      setAgentChanges([]);
    } catch (error) {
      console.error('Recalculation failed:', error);
    }
  };

  const handleScenarioSelect = (scenarioType: ScenarioType) => {
    setSelectedScenario(scenarioType);
    currentScenarioConfig.current = SCENARIOS[scenarioType];
    optimizeRoutes(undefined, undefined, scenarioType);
  };

  const optimizeRoutes = async (
    existingCases?: CaseData[],
    existingAgentSettings?: AgentSettings[],
    scenarioType?: ScenarioType
  ) => {
    setLoading(true);
    setError('');

    const scenario = scenarioType
      ? SCENARIOS[scenarioType]
      : currentScenarioConfig.current || SCENARIOS.full;

    if (!existingCases) {
      setCaseChanges([]);
      setAgentChanges([]);
    }

    const { generateMultiplePostcodes, timeToSeconds } = await import('./utils/locationGenerator');
    const { generateCasePriority } = await import('./utils/caseGenerator');
    const { getPenaltyCost } = await import('./utils/priorityMapping');
    const { geocodePostcodes } = await import('./utils/geocoding');
    const { generateDeliverySlot, timeStringToSeconds } = await import('./utils/timeSlotGenerator');

    let initialCases: CaseData[];
    let currentAgentSettings: AgentSettings[];

    if (existingCases && existingCases.length > 0) {
      initialCases = existingCases;
      currentAgentSettings = existingAgentSettings || agentSettings;
      console.log('üîÑ Recalculating with updated priorities, slots, and agent settings...');
      console.log(`  ${caseChanges.length} case changes + ${agentChanges.length} agent changes to apply`);

      caseChanges.forEach(change => {
        if ('oldPriority' in change) {
          console.log(`  - ${change.casePostcode}: priority ${change.oldPriority} ‚Üí ${change.newPriority}`);
        } else {
          const oldSlot = change.oldSlot ? `${change.oldSlot.startTime}-${change.oldSlot.endTime}` : 'None';
          const newSlot = change.newSlot ? `${change.newSlot.startTime}-${change.newSlot.endTime}` : 'None';
          console.log(`  - ${change.casePostcode}: slot ${oldSlot} ‚Üí ${newSlot}`);
        }
      });

      agentChanges.forEach(change => {
        console.log(`  - ${change.agentLabel}:`);
        console.log(`    Hours: ${change.oldSettings.startTime}-${change.oldSettings.endTime} ‚Üí ${change.newSettings.startTime}-${change.newSettings.endTime}`);
        console.log(`    Lunch: ${change.oldSettings.lunchDuration}min ‚Üí ${change.newSettings.lunchDuration}min`);
        if (change.oldSettings.startPostcode !== change.newSettings.startPostcode) {
          console.log(`    Start: ${change.oldSettings.startPostcode || 'Default'} ‚Üí ${change.newSettings.startPostcode || 'Default'}`);
        }
        if (change.oldSettings.finishPostcode !== change.newSettings.finishPostcode) {
          console.log(`    Finish: ${change.oldSettings.finishPostcode || 'None'} ‚Üí ${change.newSettings.finishPostcode || 'None'}`);
        }
      });
    } else {
      console.log(`üìç Generating ${scenario.caseCount} unique cases from real postcodes...`);
      console.log(`  Scenario: ${scenario.name}`);
      console.log(`  Agents: ${scenario.agentPostcodes.length}`);
      console.log(`  Default hours: ${scenario.defaultStartTime}-${scenario.defaultEndTime}`);

      const postcodes = generateMultiplePostcodes(scenario.caseCount);

      initialCases = postcodes.map((postcodeCase, index) => ({
        id: `case-${index + 1}`,
        postcode: postcodeCase.postcode,
        priority: generateCasePriority(),
        deliverySlot: generateDeliverySlot(),
        status: 'pending' as const,
        assignedAgentIndex: null,
      }));

      currentAgentSettings = scenario.agentPostcodes.map((postcode, index) => ({
        startTime: scenario.defaultStartTime,
        endTime: scenario.defaultEndTime,
        lunchDuration: scenario.defaultLunchDuration,
        active: true,
        startPostcode: undefined,
        startLocation: undefined,
        finishPostcode: scenario.agentFinishPostcodes?.[index],
        finishLocation: undefined,
      }));

      setAgentSettings(currentAgentSettings);
      originalAgentSettings.current = currentAgentSettings.map(s => ({ ...s }));

      console.log('üåç Geocoding postcodes...');
      const allPostcodes = [
        ...new Set([
          ...postcodes.map(p => p.postcode),
          ...scenario.agentPostcodes,
          ...(scenario.agentFinishPostcodes?.filter(Boolean) || [])
        ])
      ];

      const geocodedLocations = await geocodePostcodes(allPostcodes, (completed, total) => {
        console.log(`  Geocoded ${completed}/${total} postcodes`);
      });

      console.log(`‚úÖ Geocoded ${geocodedLocations.size} unique postcodes`);

      initialCases = initialCases.map(c => ({
        ...c,
        location: geocodedLocations.get(c.postcode),
      }));

      originalCaseData.current = new Map(
        initialCases.map(c => [c.id, { priority: c.priority, deliverySlot: c.deliverySlot }])
      );
/*
const agentLocs = scenario.agentPostcodes.map(pc => geocodedLocations.get(pc)).filter(Boolean) as Location[];
setAgentLocations(agentLocs);
*/

const agentLocs = scenario.agentPostcodes.map(pc => {
  const location = geocodedLocations.get(pc);
  if (!location) {
    console.warn(`‚ö†Ô∏è  Failed to geocode agent postcode: ${pc}`);
  }
  return location;
});
// DO NOT filter - maintain alignment with undefined values
setAgentLocations(agentLocs as (Location | undefined)[]);

      currentAgentSettings = currentAgentSettings.map(settings => {
        if (settings.finishPostcode) {
          return {
            ...settings,
            finishLocation: geocodedLocations.get(settings.finishPostcode),
          };
        }
        return settings;
      });

      setAgentSettings(currentAgentSettings);
      originalAgentSettings.current = currentAgentSettings.map(s => ({ ...s }));
    }

    const casesWithCoords = initialCases.filter(c => c.location);
    if (casesWithCoords.length < initialCases.length) {
      console.warn(`‚ö†Ô∏è ${initialCases.length - casesWithCoords.length} cases failed to geocode and will be skipped`);
    }

    const shipments = casesWithCoords.map((caseData) => {
      const baseShipment = {
        deliveries: [
          {
            arrivalLocation: {
              latitude: caseData.location!.latitude,
              longitude: caseData.location!.longitude,
            },
            duration: { seconds: 300 },
            timeWindows: [
              {
                startTime: { seconds: timeToSeconds('09:00') },
                endTime: { seconds: timeToSeconds('17:00') },
              }
            ],
          },
        ],
        label: caseData.postcode,
        penaltyCost: getPenaltyCost(caseData.priority),
      };

      if (caseData.deliverySlot) {
        baseShipment.deliveries[0].timeWindows = [{
          startTime: { seconds: timeStringToSeconds(caseData.deliverySlot.startTime) },
          endTime: { seconds: timeStringToSeconds(caseData.deliverySlot.endTime) },
        }];
      }

      return baseShipment;
    });

    const activeAgentIndices: number[] = [];
    const vehicles = scenario.agentPostcodes
      .map((postcode, index) => {
        const settings = currentAgentSettings[index];

        if (!settings.active) {
          return null;
        }

        activeAgentIndices.push(index);

        const shiftTimeWindow = {
          startTime: { seconds: timeToSeconds(settings.startTime) },
          endTime: { seconds: timeToSeconds(settings.endTime) },
        };

        // ‚úÖ Use custom start location if set, otherwise use default
        const startLocation = settings.startLocation 
          ? settings.startLocation 
          : agentLocations[index] || { latitude: 51.5074, longitude: -0.1278 };

        // ‚úÖ Use custom finish location if set, otherwise use start location
        const endLocation = settings.finishLocation
          ? settings.finishLocation
          : startLocation;

        const vehicle: any = {
          startLocation: startLocation,
          endLocation: endLocation,
          label: `Agent ${index + 1} (${settings.startPostcode || postcode})`,
          startTimeWindows: [shiftTimeWindow],
          endTimeWindows: [shiftTimeWindow],
        };

        if (settings.lunchDuration > 0) {
          const shiftStart = timeToSeconds(settings.startTime);
          const shiftEnd = timeToSeconds(settings.endTime);
          const shiftMidpoint = Math.floor((shiftStart + shiftEnd) / 2);

          vehicle.breakRule = {
            breakRequests: [
              {
                earliestStartTime: { seconds: shiftMidpoint - 1800 },
                latestStartTime: { seconds: shiftMidpoint + 1800 },
                minDuration: { seconds: settings.lunchDuration * 60 },
              },
            ],
          };
        }

        return vehicle;
      })
      .filter(vehicle => vehicle !== null);

    const londonDate = new Date();
    londonDate.setUTCHours(0, 0, 0, 0);

    console.log('üåç Setting global time context:');
    console.log(`  Start: ${londonDate.toISOString()}`);
    console.log(`  Timezone: Europe/London`);

    const requestBody = {
      model: {
        shipments,
        vehicles,
        globalStartTime: londonDate.toISOString(),
        globalEndTime: new Date(londonDate.getTime() + 24 * 60 * 60 * 1000).toISOString(),
      },
    };

    try {
      console.log('üì§ Sending optimization request...');

      if (shipments.length > 0) {
        console.log('üì¶ Sample shipment structure:', JSON.stringify(shipments[0], null, 2));
        const slotsCount = shipments.filter(s =>
          s.deliveries[0].timeWindows[0].startTime.seconds !== 32400
        ).length;
        console.log(`  Cases with delivery slots: ${slotsCount}/${shipments.length}`);
      }

      const priorityDistribution = {
        high: initialCases.filter(c => c.priority === 'high').length,
        normal: initialCases.filter(c => c.priority === 'normal').length,
      };
      console.log('üìä Priority Distribution:', priorityDistribution);
      console.log('üí∞ Penalty Costs: High=¬£500, Normal=¬£100');

      console.log('üë§ Agent Settings:');
      currentAgentSettings.forEach((settings, index) => {
        if (settings.active) {
          const startInfo = settings.startPostcode 
            ? `Start: ${settings.startPostcode}` 
            : `Start: ${scenario.agentPostcodes[index]}`;
          const finishInfo = settings.finishPostcode 
            ? ` ‚Üí Finish: ${settings.finishPostcode}` 
            : ' (returns to start)';
          console.log(
            `  Agent ${index + 1}: ${startInfo}${finishInfo}, ` +
            `${settings.startTime}-${settings.endTime}, ${settings.lunchDuration}min lunch [ACTIVE]`
          );
        } else {
          console.log(`  Agent ${index + 1}: [INACTIVE]`);
        }
      });
      console.log(`  Active agents: ${activeAgentIndices.length}/${currentAgentSettings.length}`);

      const response = await fetch('http://localhost:3001/api/optimize-routes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log('‚úÖ API Response:', data);

      const routes: OptimizedRoute[] = data.routes?.map((route: any, apiRouteIndex: number) => ({
        vehicleLabel: route.vehicleLabel || `Vehicle ${apiRouteIndex + 1}`,
        visits: route.visits?.map((visit: any) => {
          const shipmentIndex = visit.shipmentIndex;
          const caseData = casesWithCoords[shipmentIndex];

          return {
            shipmentIndex: visit.shipmentIndex,
            shipmentLabel: visit.shipmentLabel || caseData?.postcode || `Stop ${shipmentIndex + 1}`,
            startTime: visit.startTime,
            arrivalLocation: caseData?.location,
          };
        }) || [],
        metrics: {
          travelDuration: route.metrics?.travelDuration || { seconds: 0 },
          travelDistance: route.metrics?.travelDistanceMeters || 0,
        },
      })) || [];

      const fullRoutes: OptimizedRoute[] = scenario.agentPostcodes.map((postcode, index) => {
        const settings = currentAgentSettings[index];

        if (!settings.active) {
          return {
            vehicleLabel: `Agent ${index + 1} (${postcode})`,
            visits: [],
            metrics: {
              travelDuration: { seconds: 0 },
              travelDistance: 0,
            },
          };
        }

        const apiRouteIndex = activeAgentIndices.indexOf(index);
        return routes[apiRouteIndex] || {
          vehicleLabel: `Agent ${index + 1} (${postcode})`,
          visits: [],
          metrics: {
            travelDuration: { seconds: 0 },
            travelDistance: 0,
          },
        };
      });

      const updatedCases = initialCases.map(caseData => {
        let assignedRouteIndex = -1;
        let deliveryTime: string | { seconds: number } | undefined = undefined;

        for (let routeIdx = 0; routeIdx < fullRoutes.length; routeIdx++) {
          const visit = fullRoutes[routeIdx].visits.find(v => {
            return v.shipmentLabel === caseData.postcode;
          });

          if (visit) {
            assignedRouteIndex = routeIdx;
            deliveryTime = visit.startTime;
            break;
          }
        }

        return {
          ...caseData,
          assignedAgentIndex: assignedRouteIndex >= 0 ? assignedRouteIndex : null,
          deliveryTime: deliveryTime,
        };
      });

      setOptimizedRoutes(fullRoutes);
      setCases(updatedCases);
      setRoutesVersion(prev => prev + 1);
      
      // Update optimized agent settings - these are what the map will display
      setOptimizedAgentSettings(currentAgentSettings.map(s => ({ ...s })));
      
      // Update original case data to reflect the priorities/slots used in this optimization
      originalCaseData.current = new Map(
        updatedCases.map(c => [c.id, { priority: c.priority, deliverySlot: c.deliverySlot }])
      );
      
      // Update original agent settings to reflect settings used in this optimization
      originalAgentSettings.current = currentAgentSettings.map(s => ({ ...s }));
    } catch (err) {
      console.error('‚ùå Error:', err);
      setError(err instanceof Error ? err.message : 'An error occurred');
    } finally {
      setLoading(false);
    }
  };

  if (loadError) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-100">
        <div className="text-center p-8 bg-white rounded-lg shadow-lg">
          <h2 className="text-xl font-bold text-red-600 mb-4">‚ùå Map Loading Error:</h2>
          <p className="text-gray-700">Failed to load Google Maps. Please check your API key.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen bg-gray-50">
      <Header />

      <div className="flex flex-1 overflow-hidden">
        <div className="flex-1 relative">
          {!googleMapsApiKey && (
            <div className="absolute inset-0 flex items-center justify-center bg-gray-100 z-10">
              <div className="text-center p-8 bg-white rounded-lg shadow-lg max-w-md">
                <h2 className="text-xl font-bold text-yellow-600 mb-4">‚ö†Ô∏è Google Maps API Key Missing:</h2>
                <p className="text-gray-700">
                  Add `VITE_GOOGLE_MAPS_API_KEY` to your .env file to enable the map.
                </p>
              </div>
            </div>
          )}

          {optimizedRoutes.length === 0 && !loading && (
            <div className="absolute inset-0 flex items-center justify-center bg-gray-50 z-10">
              <div className="max-w-4xl w-full px-8">
                <h1 className="text-3xl font-bold text-gray-900 mb-8 text-center">
                  Choose Optimization Scenario
                </h1>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200 hover:border-blue-400 transition-colors">
                    <h2 className="text-2xl font-bold text-blue-600 mb-4">üìä Full Scenario</h2>
                    <ul className="space-y-2 mb-6 text-gray-700">
                      <li>‚úì 200 cases across London</li>
                      <li>‚úì 6 agents (W6 9LI, W2 3EL, SE12 4WH, E10 1PI, SE14 5NP, SW15 7GB)</li>
                      <li>‚úì Default hours: 09:00-17:00</li>
                      <li>‚úì 45-minute lunch break</li>
                      <li>‚úì Priority-based optimization</li>
                      <li>‚úì ~1 in 12 cases with delivery slots</li>
                      <li>‚úì Agent 1 finishes at SW1A 1AA</li>
                    </ul>
                    <button
                      onClick={() => handleScenarioSelect('full')}
                      className="w-full px-6 py-3 text-base font-bold text-white bg-blue-500 border-none rounded cursor-pointer hover:bg-blue-600 transition-colors"
                    >
                      üöÄ Run Full Scenario
                    </button>
                  </div>

                  <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-green-200 hover:border-green-400 transition-colors">
                    <h2 className="text-2xl font-bold text-green-600 mb-4">üìâ Reduced Scenario</h2>
                    <ul className="space-y-2 mb-6 text-gray-700">
                      <li>‚úì 8 cases across London</li>
                      <li>‚úì 2 agents (W6 9LI, SE14 5NP)</li>
                      <li>‚úì Default hours: 10:30-14:00</li>
                      <li>‚úì 45-minute lunch break</li>
                      <li>‚úì Priority-based optimization</li>
                      <li>‚úì ~1 in 12 cases with delivery slots</li>
                      <li>‚úì Agent 1 finishes at EC1A 1BB</li>
                    </ul>
                    <button
                      onClick={() => handleScenarioSelect('reduced')}
                      className="w-full px-6 py-3 text-base font-bold text-white bg-green-500 border-none rounded cursor-pointer hover:bg-green-600 transition-colors"
                    >
                      üöÄ Run Reduced Scenario
                    </button>
                  </div>
                </div>

                <p className="text-center text-sm text-gray-600 mt-6">
                  All scenarios use real London postcodes and Google Route Optimization API
                </p>
              </div>
            </div>
          )}

          {loading && optimizedRoutes.length === 0 && (
            <div className="absolute inset-0 flex items-center justify-center bg-gray-50 z-10">
              <div className="text-center">
                <div className="text-4xl mb-4">‚è≥</div>
                <h2 className="text-xl font-bold text-gray-900 mb-2">Geocoding & Optimizing...</h2>
                <p className="text-gray-600">
                  {selectedScenario === 'full'
                    ? 'Processing 200 cases across 6 agents'
                    : 'Processing 8 cases across 2 agents'}
                </p>
              </div>
            </div>
          )}

          {error && (
            <div className="absolute inset-0 flex items-center justify-center bg-gray-50 z-10">
              <div className="text-center p-8 bg-white rounded-lg shadow-lg max-w-md">
                <h2 className="text-xl font-bold text-red-600 mb-4">‚ùå Error:</h2>
                <p className="text-gray-700">{error}</p>
              </div>
            </div>
          )}

          {optimizedRoutes.length > 0 && googleMapsApiKey && isLoaded && (
            <div className="relative w-full h-full">
              <RouteMap
                routes={optimizedRoutes}
                agentLocations={agentLocations}
                cases={cases}
                unallocatedCases={unallocatedCases}
                routesVersion={routesVersion}
                agentSettings={optimizedAgentSettings}
                originalCasePriorities={originalCaseData.current}
              />
            </div>
          )}

          {optimizedRoutes.length > 0 && googleMapsApiKey && !isLoaded && (
            <div className="absolute inset-0 flex items-center justify-center bg-gray-100">
              <div className="text-lg text-gray-700">Loading map...</div>
            </div>
          )}
        </div>

        {optimizedRoutes.length > 0 && (
          <div className="w-[400px] border-l border-gray-200 bg-white">
            <RouteDetails
              routes={optimizedRoutes}
              cases={cases}
              agentSettings={agentSettings}
              onPriorityChange={handlePriorityChange}
              onSlotChange={handleSlotChange}
              onAgentSettingsChange={handleAgentSettingsChange}
              caseChanges={caseChanges}
              agentChanges={agentChanges}
              onRecalculate={handleRecalculate}
              onDeleteCaseChange={handleDeleteCaseChange}
              onDeleteAgentChange={handleDeleteAgentChange}
              isRecalculating={loading}
              onUnallocatedCasesUpdate={setUnallocatedCases}
            />
          </div>
        )}
      </div>
    </div>
  );
};

export default RouteOptimizer;

// components/AgentCard.tsx - UPDATED with Reset removed from start location

import React, { useState, useEffect } from 'react';
import type { OptimizedRoute, AgentSettings, CaseData, CasePriority, TimeSlot, Location } from '../types/route';
import { generateTimeOptions, generateLunchOptions } from '../utils/timeSlotGenerator';
import { formatTimeWithoutSeconds } from '../utils/formatters';
import { TimeSlotInput } from './TimeSlotInput';
import { geocodePostcode } from '../utils/geocoding';

interface AgentCardProps {
  route: OptimizedRoute;
  index: number;
  color: string;
  settings: AgentSettings;
  cases: CaseData[];
  onSettingsChange: (index: number, settings: AgentSettings) => void;
  onPriorityChange: (caseId: string, priority: CasePriority) => void;
  onSlotChange: (caseId: string, slot: TimeSlot | undefined) => void;
}

// Create agent icon SVG as data URL
const createAgentIcon = (color: string): string => {
  const svg = `
    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
      <g transform="translate(20, 21) scale(0.8)">
        <path d="M-6 -8 A 6 6 0 1 1 6 -8 A 6 6 0 1 1 -6 -8 Z" fill="white"/>
        <path d="M -10 8 Q -10 0, -6 -2 L 6 -2 Q 10 0, 10 8 Z" fill="white"/>
      </g>
    </svg>
  `;
  return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
};

// Format duration as hours and minutes (e.g., "2h 34m")
const formatDurationHoursMinutes = (duration: string | { seconds: number } | any): string => {
  let seconds = 0;
  
  if (duration && typeof duration === 'object' && 'seconds' in duration) {
    seconds = duration.seconds;
  } else if (typeof duration === 'string') {
    const match = duration.match(/(\d+)s/);
    if (match) {
      seconds = parseInt(match[1]);
    }
  }
  
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  
  if (hours > 0) {
    return `${hours}h ${minutes}m`;
  }
  return `${minutes}m`;
};

export const AgentCard: React.FC<AgentCardProps> = ({ 
  route, 
  index, 
  color, 
  settings, 
  cases,
  onSettingsChange,
  onPriorityChange,
  onSlotChange
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [expandedCaseId, setExpandedCaseId] = useState<string | null>(null);
  
  // State for editing start location
  const [showStartInput, setShowStartInput] = useState(false);
  const [startPostcodeInput, setStartPostcodeInput] = useState('');
  const [isGeocodingStart, setIsGeocodingStart] = useState(false);
  
  // State for editing finish location
  const [showFinishInput, setShowFinishInput] = useState(false);
  const [finishPostcodeInput, setFinishPostcodeInput] = useState('');
  const [isGeocodingFinish, setIsGeocodingFinish] = useState(false);

  // Extract agent name and default postcode from vehicleLabel
  const agentLabel = route.vehicleLabel.replace('Vehicle', 'Agent');
  const agentName = agentLabel.split(' (')[0]; // "Agent 1"
  const defaultAgentPostcode = agentLabel.match(/\(([^)]+)\)/)?.[1] || ''; // "SW1 4GO"
  
  // Use custom start postcode if set, otherwise use default
  const displayStartPostcode = settings.startPostcode || defaultAgentPostcode;

  const timeOptions = generateTimeOptions(true);
  const lunchOptions = generateLunchOptions();

  // Reset case list when agent becomes inactive
  useEffect(() => {
    if (!settings.active) {
      setIsExpanded(false);
      setExpandedCaseId(null);
    }
  }, [settings.active]);

  // Reset expanded case when case list is collapsed
  useEffect(() => {
    if (!isExpanded) {
      setExpandedCaseId(null);
    }
  }, [isExpanded]);

  // Helper to get case by postcode
  const getCaseByPostcode = (postcode: string): CaseData | undefined => {
    return cases.find(c => c.postcode === postcode);
  };

  const handleStartTimeChange = (newStartTime: string) => {
    if (newStartTime >= settings.endTime) {
      return;
    }
    onSettingsChange(index, {
      ...settings,
      startTime: newStartTime,
    });
  };

  const handleEndTimeChange = (newEndTime: string) => {
    if (newEndTime <= settings.startTime) {
      return;
    }
    onSettingsChange(index, {
      ...settings,
      endTime: newEndTime,
    });
  };

  const handleLunchChange = (newLunchDuration: number) => {
    onSettingsChange(index, {
      ...settings,
      lunchDuration: newLunchDuration,
    });
  };

  const handleCaseClick = (caseId: string) => {
    setExpandedCaseId(expandedCaseId === caseId ? null : caseId);
  };

  // Start location handlers
  const handleEditStartClick = () => {
    setShowStartInput(true);
    setStartPostcodeInput(displayStartPostcode);
  };

  const handleUpdateStart = async () => {
    if (!startPostcodeInput.trim()) return;

    setIsGeocodingStart(true);
    try {
      const location = await geocodePostcode(startPostcodeInput.trim());
      if (location) {
        onSettingsChange(index, {
          ...settings,
          startPostcode: startPostcodeInput.trim(),
          startLocation: location,
        });
        setShowStartInput(false);
        setStartPostcodeInput('');
      } else {
        alert('Could not geocode postcode. Please check and try again.');
      }
    } catch (error) {
      console.error('Error geocoding start location:', error);
      alert('Error geocoding postcode. Please try again.');
    } finally {
      setIsGeocodingStart(false);
    }
  };

  // ‚ùå REMOVED: handleResetStart function

  const handleCancelStartInput = () => {
    setShowStartInput(false);
    setStartPostcodeInput('');
  };

  // Finish location handlers with Edit support
  const handleAddFinishClick = () => {
    setShowFinishInput(true);
    setFinishPostcodeInput('');
  };

  const handleEditFinishClick = () => {
    setShowFinishInput(true);
    setFinishPostcodeInput(settings.finishPostcode || '');
  };

  const handleUpdateFinish = async () => {
    if (!finishPostcodeInput.trim()) return;

    setIsGeocodingFinish(true);
    try {
      const location = await geocodePostcode(finishPostcodeInput.trim());
      if (location) {
        onSettingsChange(index, {
          ...settings,
          finishPostcode: finishPostcodeInput.trim(),
          finishLocation: location,
        });
        setShowFinishInput(false);
        setFinishPostcodeInput('');
      } else {
        alert('Could not geocode postcode. Please check and try again.');
      }
    } catch (error) {
      console.error('Error geocoding finish location:', error);
      alert('Error geocoding postcode. Please try again.');
    } finally {
      setIsGeocodingFinish(false);
    }
  };

  const handleRemoveFinish = () => {
    onSettingsChange(index, {
      ...settings,
      finishPostcode: undefined,
      finishLocation: undefined,
    });
  };

  const handleCancelFinishInput = () => {
    setShowFinishInput(false);
    setFinishPostcodeInput('');
  };

  return (
    <div className="p-4 bg-white border border-gray-300 rounded-lg shadow-sm">
      {/* Agent Icon and Name */}
      <div className="flex items-center gap-3 mb-2">
        <img 
          src={createAgentIcon(color)} 
          alt={agentName}
          className="w-10 h-10"
        />
        <h3 className="text-base font-bold text-gray-900">{agentName}</h3>
        
        {/* Active/Inactive Toggle */}
        <div className="ml-auto flex items-center gap-2">
          <span className="text-xs font-medium text-gray-700">
            {settings.active ? 'Active' : 'Inactive'}
          </span>
          <button
            onClick={() =>
              onSettingsChange(index, {
                ...settings,
                active: !settings.active,
              })
            }
            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors cursor-pointer ${
              settings.active ? 'bg-blue-500' : 'bg-gray-300'
            }`}
            aria-label="Toggle agent active state"
          >
            <span
              className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                settings.active ? 'translate-x-6' : 'translate-x-1'
              }`}
            />
          </button>
        </div>
      </div>

      {/* Start Location - Only show when active */}
      {settings.active && (
        <div className="flex items-center justify-between mb-3">
          {/* LHS - Home icon and postcode */}
          <div className="flex items-center gap-2">
            {!showStartInput && (
              <>
                <svg 
                  width="14" 
                  height="14" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  strokeWidth="2" 
                  strokeLinecap="round" 
                  strokeLinejoin="round"
                  className="text-gray-600"
                >
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span className="text-sm text-gray-700">{displayStartPostcode}</span>
              </>
            )}
            {showStartInput && (
              <div className="flex items-center gap-2">
                <svg 
                  width="14" 
                  height="14" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  strokeWidth="2" 
                  strokeLinecap="round" 
                  strokeLinejoin="round"
                  className="text-gray-600"
                >
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <input
                  type="text"
                  value={startPostcodeInput}
                  onChange={(e) => setStartPostcodeInput(e.target.value)}
                  placeholder="Enter postcode"
                  className="text-xs border border-gray-300 rounded px-2 py-1 w-32"
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') handleUpdateStart();
                  }}
                  disabled={isGeocodingStart}
                />
                <button
                  onClick={handleUpdateStart}
                  disabled={isGeocodingStart || !startPostcodeInput.trim()}
                  className="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  {isGeocodingStart ? '...' : 'Update'}
                </button>
                <button
                  onClick={handleCancelStartInput}
                  disabled={isGeocodingStart}
                  className="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed"
                >
                  Cancel
                </button>
              </div>
            )}
          </div>

          {/* RHS - Edit button only (Reset removed) */}
          <div className="ml-auto">
            {!showStartInput && (
              <button
                onClick={handleEditStartClick}
                className="text-xs text-blue-600 hover:text-blue-700 font-medium cursor-pointer"
              >
                Edit
              </button>
            )}
          </div>
        </div>
      )}

      {/* Finish Location - Only show when active */}
      {settings.active && (
        <div className="flex items-center justify-between mb-3">
          {/* LHS - Chequered flag icon and postcode (if finish location exists) */}
          <div className="flex items-center gap-2">
            {settings.finishPostcode && !showFinishInput && (
              <>
                <svg 
                  width="14" 
                  height="14" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  strokeWidth="2" 
                  strokeLinecap="round" 
                  strokeLinejoin="round"
                  className="text-gray-600"
                >
                  <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                  <line x1="4" y1="22" x2="4" y2="15"></line>
                </svg>
                <span className="text-sm text-gray-700">{settings.finishPostcode}</span>
              </>
            )}
            {showFinishInput && (
              <>
                <svg 
                  width="14" 
                  height="14" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  strokeWidth="2" 
                  strokeLinecap="round" 
                  strokeLinejoin="round"
                  className="text-gray-600"
                >
                  <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                  <line x1="4" y1="22" x2="4" y2="15"></line>
                </svg>
                <div className="flex items-center gap-2">
                  <input
                    type="text"
                    value={finishPostcodeInput}
                    onChange={(e) => setFinishPostcodeInput(e.target.value)}
                    placeholder="Enter postcode"
                    className="text-xs border border-gray-300 rounded px-2 py-1 w-32"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') handleUpdateFinish();
                    }}
                    disabled={isGeocodingFinish}
                  />
                  <button
                    onClick={handleUpdateFinish}
                    disabled={isGeocodingFinish || !finishPostcodeInput.trim()}
                    className="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    {isGeocodingFinish ? '...' : settings.finishPostcode ? 'Update' : 'Add'}
                  </button>
                  <button
                    onClick={handleCancelFinishInput}
                    disabled={isGeocodingFinish}
                    className="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed"
                  >
                    Cancel
                  </button>
                </div>
              </>
            )}
          </div>

          {/* RHS - Add/Edit/Remove buttons */}
          <div className="ml-auto">
            {!settings.finishPostcode && !showFinishInput && (
              <button
                onClick={handleAddFinishClick}
                className="text-xs text-blue-600 hover:text-blue-700 font-medium cursor-pointer"
              >
                + Add Finish
              </button>
            )}

            {settings.finishPostcode && !showFinishInput && (
              <div className="flex items-center gap-2">
                <button
                  onClick={handleEditFinishClick}
                  className="text-xs text-blue-600 hover:text-blue-700 font-medium cursor-pointer"
                >
                  Edit
                </button>
                <button
                  onClick={handleRemoveFinish}
                  className="flex items-center gap-1 text-[10px] text-gray-500 hover:text-gray-700 cursor-pointer"
                >
                  <span>Remove</span>
                  <svg 
                    width="12" 
                    height="12" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                  >
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Agent Settings Controls - Only show when active */}
      {settings.active && (
        <div className="mb-3 p-3 bg-gray-50 rounded">
          <h4 className="text-xs font-bold text-gray-700 mb-2">Work Schedule</h4>

          {/* Start and End Time */}
          <div className="grid grid-cols-2 gap-2 mb-2">
            <div>
              <label className="block text-[10px] font-medium text-gray-600 mb-1">
                Start Time
              </label>
              <select
                value={settings.startTime}
                onChange={(e) => handleStartTimeChange(e.target.value)}
                disabled={!settings.active}
                className="w-full text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed"
              >
                {timeOptions.map((time) => (
                  <option key={time} value={time} disabled={time >= settings.endTime}>
                    {time}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-[10px] font-medium text-gray-600 mb-1">
                End Time
              </label>
              <select
                value={settings.endTime}
                onChange={(e) => handleEndTimeChange(e.target.value)}
                disabled={!settings.active}
                className="w-full text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed"
              >
                {timeOptions.map((time) => (
                  <option key={time} value={time} disabled={time <= settings.startTime}>
                    {time}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* Lunch Break */}
          <div>
            <label className="block text-[10px] font-medium text-gray-600 mb-1">
              Lunch Break
            </label>
            <select
              value={settings.lunchDuration}
              onChange={(e) => handleLunchChange(Number(e.target.value))}
              disabled={!settings.active}
              className="w-full text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              {lunchOptions.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>
        </div>
      )}

      {/* Route Details - Only show if agent is active */}
      {settings.active && (
        <>
          {/* Metrics Row - Cases, Distance, Duration without icons */}
          <div className="flex justify-between mb-3 px-1">
            <div className="flex flex-col items-center">
              <div className="text-[10px] font-medium text-gray-600 mb-1">Cases</div>
              <div className="text-sm font-bold text-gray-900">{route.visits.length}</div>
            </div>
            <div className="flex flex-col items-center">
              <div className="text-[10px] font-medium text-gray-600 mb-1">Distance</div>
              <div className="text-sm font-bold text-gray-900">
                {(route.metrics.travelDistance / 1000).toFixed(1)} km
              </div>
            </div>
            <div className="flex flex-col items-center">
              <div className="text-[10px] font-medium text-gray-600 mb-1">Duration</div>
              <div className="text-sm font-bold text-gray-900">
                {formatDurationHoursMinutes(route.metrics.travelDuration)}
              </div>
            </div>
          </div>

          {/* Expandable Case List */}
          <button
            onClick={() => setIsExpanded(!isExpanded)}
            className="px-3 py-2 text-xs font-medium w-full rounded border border-blue-400 bg-white hover:bg-blue-50 text-gray-700 transition-colors flex items-center justify-center gap-1.5"
          >
            <svg 
              width="12" 
              height="12" 
              viewBox="0 0 12 12" 
              fill="none" 
              className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`}
            >
              <path 
                d="M3 4.5L6 7.5L9 4.5" 
                stroke="currentColor" 
                strokeWidth="1.5" 
                strokeLinecap="round" 
                strokeLinejoin="round"
              />
            </svg>
            {isExpanded ? 'Hide Cases' : `View Cases (${route.visits.length})`}
          </button>

          {isExpanded && (
            <>
              <div className="mt-2 space-y-1">
                {route.visits.map((visit, i) => {
                  const caseData = getCaseByPostcode(visit.shipmentLabel);
                  if (!caseData) return null;
                  
                  const isHighPriority = caseData.priority === 'high';
                  const formattedTime = formatTimeWithoutSeconds(visit.startTime);
                  const status = caseData.status || 'pending';
                  const isThisCaseExpanded = expandedCaseId === caseData.id;
                  
                  return (
                    <div
                      key={i}
                      className={`text-xs bg-gray-50 rounded overflow-hidden ${
                        isThisCaseExpanded ? 'border border-gray-300' : ''
                      }`}
                    >
                      {/* Case Header */}
                      <div
                        onClick={() => !isThisCaseExpanded && handleCaseClick(caseData.id)}
                        className={`flex items-center justify-between p-2 ${
                          !isThisCaseExpanded ? 'cursor-pointer hover:bg-gray-100' : ''
                        }`}
                      >
                        {/* LHS: Colored circle with number */}
                        <div className="flex items-center gap-2 flex-shrink-0">
                          <div className="relative">
                            <div
                              className="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px] font-bold"
                              style={{ 
                                backgroundColor: color,
                                ...(isHighPriority ? {
                                  border: '2px solid white',
                                  outlineWidth: '1px',
                                  outlineStyle: 'solid',
                                  outlineColor: color,
                                } : {})
                              }}
                            >
                              {i + 1}
                            </div>
                            {isHighPriority && (
                              <div className="absolute -top-0.5 -right-0.5 w-3 h-3 bg-red-600 rounded-full border border-white flex items-center justify-center text-white text-[7px] font-bold">
                                !
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Middle: Postcode and Time */}
                        <div className="flex-1 ml-2">
                          <div className="text-gray-900 font-medium">{visit.shipmentLabel}</div>
                          {formattedTime && (
                            <div className="text-gray-600 text-[10px]">
                              {formattedTime} ({status})
                            </div>
                          )}
                        </div>

                        {/* RHS: Chevron or Close Button */}
                        {isThisCaseExpanded ? (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setExpandedCaseId(null);
                            }}
                            className="flex-shrink-0 flex items-center gap-1 text-gray-500 hover:text-gray-700 px-1 text-[10px] cursor-pointer"
                          >
                            <span>Close</span>
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                              <path d="M4 10L8 6L12 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                            </svg>
                          </button>
                        ) : (
                          <div className="flex-shrink-0 text-gray-400">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                              <path d="M4 6L8 10L12 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                            </svg>
                          </div>
                        )}
                      </div>

                      {/* Expanded Content - Priority and Time Slot */}
                      {isThisCaseExpanded && (
                        <div className="px-2 pb-2 pt-1">
                          {/* Priority Dropdown */}
                          <div className="mb-2">
                            <label className="block text-xs font-medium text-gray-600 mb-1">
                              Priority
                            </label>
                            <select
                              value={caseData.priority}
                              onChange={(e) =>
                                onPriorityChange(caseData.id, e.target.value as CasePriority)
                              }
                              className="w-full text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer"
                            >
                              <option value="normal">Normal</option>
                              <option value="high">High</option>
                            </select>
                          </div>

                          {/* Time Slot Input */}
                          <TimeSlotInput
                            caseId={caseData.id}
                            deliverySlot={caseData.deliverySlot}
                            onSlotChange={onSlotChange}
                          />
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </>
          )}
        </>
      )}

      {/* Inactive Message */}
      {!settings.active && (
        <div className="text-center py-3 text-xs text-gray-500 bg-gray-50 rounded">
          Agent is inactive and will not be included in route optimization
        </div>
      )}
    </div>
  );
};

import React from 'react';
import type { CaseData, CasePriority, TimeSlot } from '../types/route';
import { formatTime, formatTimeWithoutSeconds } from '../utils/formatters';
import { TimeSlotInput } from './TimeSlotInput';

interface CaseCardProps {
  caseData: CaseData;
  agentLabel: string | null;
  agentColor: string;
  routeNumber: number | null;
  unallocatedNumber: number | null;
  onPriorityChange: (caseId: string, priority: CasePriority) => void;
  onSlotChange: (caseId: string, slot: TimeSlot | undefined) => void;
}

const PRIORITY_COLORS = {
  high: 'bg-red-100 text-red-800 border-red-300',
  medium: 'bg-yellow-100 text-yellow-800 border-yellow-300',
  low: 'bg-green-100 text-green-800 border-green-300',
};

export const CaseCard: React.FC<CaseCardProps> = ({
  caseData,
  agentLabel,
  agentColor,
  routeNumber,
  unallocatedNumber,
  onPriorityChange,
  onSlotChange,
}) => {
  const isHighPriority = caseData.priority === 'high';

  // Format agent label - extract just "Agent X" from "Agent X (postcode)"
  const formattedAgentLabel = agentLabel 
    ? agentLabel.split(' (')[0] // Remove postcode part
    : 'Unallocated';

  return (
    <div className={`p-4 bg-white rounded-lg shadow-sm ${
      isHighPriority ? 'border-2 border-red-500' : 'border border-gray-300'
    }`}>
      {/* Header Row: Postcode with Icon (LHS) and Circle + Agent Label (RHS) */}
      <div className="flex items-center justify-between mb-3">
        {/* Postcode with clipboard icon on LHS */}
        <div className="flex items-center gap-2">
          <svg 
            width="16" 
            height="16" 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            strokeWidth="2" 
            strokeLinecap="round" 
            strokeLinejoin="round"
            className="text-gray-600"
          >
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
          </svg>
          <span className="text-sm font-semibold text-gray-900">
            {caseData.postcode}
          </span>
        </div>

        {/* Circle + Agent Label on RHS */}
        <div className="flex items-center gap-2">
          {/* Route/Unallocated Number Circle */}
          {routeNumber !== null && (
            <div className="relative shrink-0">
              <div
                className="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold"
                style={{ 
                  backgroundColor: agentColor,
                  ...(isHighPriority ? {
                    border: '3px solid white',
                    outlineWidth: '2px',
                    outlineStyle: 'solid',
                    outlineColor: agentColor,
                  } : {})
                }}
              >
                {routeNumber}
              </div>
              {isHighPriority && (
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full border-2 border-white flex items-center justify-center text-white text-[8px] font-bold">
                  !
                </div>
              )}
            </div>
          )}
          {unallocatedNumber !== null && (
            <div className="relative shrink-0">
              <div 
                className="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold bg-gray-600"
                style={{
                  ...(isHighPriority ? {
                    border: '3px solid white',
                    outlineWidth: '2px',
                    outlineStyle: 'solid',
                    outlineColor: '#6b7280',
                  } : {})
                }}
              >
                {unallocatedNumber}
              </div>
              {isHighPriority && (
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full border-2 border-white flex items-center justify-center text-white text-[8px] font-bold">
                  !
                </div>
              )}
            </div>
          )}
          
          {/* Agent Label - regular color */}
          <span className="text-sm font-semibold text-gray-900">
            {formattedAgentLabel}
          </span>
        </div>
      </div>

      {/* Arrival Time and Priority Row */}
<div className="grid grid-cols-2 gap-2 mb-3">
  <div className="flex flex-col justify-center">
    <label className="block text-xs font-medium text-gray-600 mb-1">
      Arrival Time
    </label>
    <div className="text-xs text-gray-700">
      {caseData.deliveryTime ? (
        <>
          üïê {formatTimeWithoutSeconds(caseData.deliveryTime)} ({caseData.status === 'complete' ? 'complete' : 'pending'})
        </>
      ) : (
        <span className="text-gray-400">Not scheduled</span>
      )}
    </div>
  </div>
  <div>
    <label className="block text-xs font-medium text-gray-600 mb-1">
      Priority
    </label>
    {/* ‚úÖ UPDATED: Only 'normal' and 'high' options */}
    <select
      value={caseData.priority}
      onChange={(e) =>
        onPriorityChange(caseData.id, e.target.value as CasePriority)
      }
      className="w-full text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer"
    >
      <option value="normal">Normal</option>
      <option value="high">High</option>
    </select>
  </div>
</div>

      {/* Time Slot - moved to bottom */}
      <TimeSlotInput
        caseId={caseData.id}
        deliverySlot={caseData.deliverySlot}
        onSlotChange={onSlotChange}
      />
    </div>
  );
};

// components/ChangesPanel.tsx - UPDATED to show actual default postcode
import React, { useEffect } from 'react';
import type { CaseChange, PriorityChange, TimeSlotChange, AgentChange } from '../types/route';

interface ChangesPanelProps {
  caseChanges: CaseChange[];
  agentChanges: AgentChange[];
  onRecalculate: () => void;
  onDeleteCaseChange: (caseId: string, changeType: 'priority' | 'slot') => void;
  onDeleteAgentChange: (agentIndex: number) => void;
  isRecalculating: boolean;
  isExpanded: boolean;
  onToggleExpanded: (expanded: boolean) => void;
}

const ROUTE_COLORS = [
  '#4285f4',
  '#ea4335',
  '#fbbc04',
  '#34a853',
  '#ff6d00',
  '#9c27b0',
  '#00bcd4',
  '#e91e63',
];

const createAgentIcon = (color: string): string => {
  const svg = `
    <svg width="28" height="28" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
      <g transform="translate(20, 21) scale(0.8)">
        <path d="M-6 -8 A 6 6 0 1 1 6 -8 A 6 6 0 1 1 -6 -8 Z" fill="white"/>
        <path d="M -10 8 Q -10 0, -6 -2 L 6 -2 Q 10 0, 10 8 Z" fill="white"/>
      </g>
    </svg>
  `;
  return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
};

const PRIORITY_LABELS = {
  high: 'HIGH',
  normal: 'NORMAL',
};

// ‚úÖ NEW: Helper function to extract default postcode from agent label
const getDefaultPostcodeFromLabel = (agentLabel: string): string | null => {
  // Agent label format: "Agent 1 (W6 9LI)"
  const match = agentLabel.match(/\(([^)]+)\)/);
  return match ? match[1] : null;
};

export const ChangesPanel: React.FC<ChangesPanelProps> = ({ 
  caseChanges,
  agentChanges,
  onRecalculate,
  onDeleteCaseChange,
  onDeleteAgentChange,
  isRecalculating,
  isExpanded,
  onToggleExpanded
}) => {
  const totalChanges = caseChanges.length + agentChanges.length;

  useEffect(() => {
    if (isRecalculating) {
      onToggleExpanded(false);
    }
  }, [isRecalculating, onToggleExpanded]);

  if (totalChanges === 0 && !isRecalculating) return null;

  return (
    <div className={`border border-x-0 border-b-0 ${isExpanded ? 'border-t-0' : ''} border-gray-300 bg-white shrink-0 rounded-t-xl flex flex-col ${isExpanded ? 'h-full' : ''}`}>
      <div className="px-3 py-3 flex justify-between items-center border-b border-gray-200 shrink-0">
        <span className="text-sm font-medium text-gray-700">
          {isRecalculating && totalChanges === 0 
            ? 'Recalculating...' 
            : `${totalChanges} pending change${totalChanges !== 1 ? 's' : ''}`
          }
        </span>
        {totalChanges > 0 && (
          <button
            onClick={() => onToggleExpanded(!isExpanded)}
            disabled={isRecalculating}
            className={`px-3 py-1 text-xs font-medium rounded cursor-pointer ${
              isRecalculating 
                ? 'bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-300'
                : isExpanded
                  ? 'bg-transparent text-gray-500 border border-blue-500 hover:bg-gray-50'
                  : 'bg-blue-500 text-white border-none hover:bg-blue-600'
            }`}
          >
            {isExpanded ? 'Hide Changes' : 'View Changes'}
          </button>
        )}
      </div>

      {isExpanded && totalChanges > 0 && (
        <div 
          className="flex-1 overflow-y-auto border-b border-gray-200 min-h-0"
          style={{ marginTop: '2px' }}
        >
          <div className="p-3">
            {agentChanges.map((change, index) => {
              const agentColor = ROUTE_COLORS[change.agentIndex % ROUTE_COLORS.length];
              const agentName = change.agentLabel.split(' (')[0];
              
              // ‚úÖ NEW: Extract default postcode from agent label
              const defaultPostcode = getDefaultPostcodeFromLabel(change.agentLabel);
              
              return (
                <div 
                  key={`agent-${index}`}
                  className="mb-2 last:mb-0 p-2 bg-blue-50 rounded text-xs border border-blue-200 flex justify-between items-start gap-2"
                >
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <img 
                        src={createAgentIcon(agentColor)} 
                        alt={agentName}
                        className="w-7 h-7"
                      />
                      <div className="font-semibold text-gray-800">
                        {agentName}
                      </div>
                    </div>
                    
                    <div>
                      {/* Status Change (Active/Inactive) */}
                      {change.oldSettings.active !== change.newSettings.active && (
                        <>
                          <div className="text-[10px] text-gray-500 mb-0.5">Status</div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-gray-800">
                              {change.oldSettings.active ? 'Active' : 'Inactive'}
                            </span>
                            <span className="text-gray-400">‚Üí</span>
                            <span className="font-medium text-gray-800">
                              {change.newSettings.active ? 'Active' : 'Inactive'}
                            </span>
                          </div>
                        </>
                      )}

                      {/* ‚úÖ UPDATED: Start Location Change - Show actual postcode */}
                      {change.oldSettings.startPostcode !== change.newSettings.startPostcode && (
                        <>
                          <div className="text-[10px] text-gray-500 mb-0.5">Start Location</div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-gray-800">
                              {change.oldSettings.startPostcode || defaultPostcode || 'Default'}
                            </span>
                            <span className="text-gray-400">‚Üí</span>
                            <span className="font-medium text-gray-800">
                              {change.newSettings.startPostcode || defaultPostcode || 'Default'}
                            </span>
                          </div>
                        </>
                      )}

                      {/* Work Hours Change */}
                      {(change.oldSettings.startTime !== change.newSettings.startTime || 
                        change.oldSettings.endTime !== change.newSettings.endTime) && (
                        <>
                          <div className="text-[10px] text-gray-500 mb-0.5">Work Hours</div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-gray-800">
                              {change.oldSettings.startTime}-{change.oldSettings.endTime}
                            </span>
                            <span className="text-gray-400">‚Üí</span>
                            <span className="font-medium text-gray-800">
                              {change.newSettings.startTime}-{change.newSettings.endTime}
                            </span>
                          </div>
                        </>
                      )}

                      {/* Lunch Break Change */}
                      {change.oldSettings.lunchDuration !== change.newSettings.lunchDuration && (
                        <>
                          <div className="text-[10px] text-gray-500 mb-0.5">Lunch Break</div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-gray-800">
                              {change.oldSettings.lunchDuration} min
                            </span>
                            <span className="text-gray-400">‚Üí</span>
                            <span className="font-medium text-gray-800">
                              {change.newSettings.lunchDuration} min
                            </span>
                          </div>
                        </>
                      )}

                      {/* Finish Location Change */}
                      {change.oldSettings.finishPostcode !== change.newSettings.finishPostcode && (
                        <>
                          <div className="text-[10px] text-gray-500 mb-0.5">Finish Location</div>
                          <div className="flex items-center gap-2">
                            <span className="font-medium text-gray-800">
                              {change.oldSettings.finishPostcode || 'None (returns to start)'}
                            </span>
                            <span className="text-gray-400">‚Üí</span>
                            <span className="font-medium text-gray-800">
                              {change.newSettings.finishPostcode || 'None (returns to start)'}
                            </span>
                          </div>
                        </>
                      )}
                    </div>
                    
                    <div className="text-gray-500 text-[10px] mt-1">
                      {change.timestamp.toLocaleTimeString()}
                    </div>
                  </div>
                  
                  <button
                    onClick={() => onDeleteAgentChange(change.agentIndex)}
                    disabled={isRecalculating}
                    className={`shrink-0 flex items-center gap-1 text-[10px] rounded border-none transition-colors p-1.5 ${
                      isRecalculating
                        ? 'text-gray-300 cursor-not-allowed bg-transparent'
                        : 'text-gray-500 hover:text-gray-700 cursor-pointer bg-transparent'
                    }`}
                    title={isRecalculating ? 'Cannot delete while recalculating' : 'Restore original settings'}
                  >
                    <span>Delete</span>
                    <svg 
                      width="12" 
                      height="12" 
                      viewBox="0 0 24 24" 
                      fill="none" 
                      stroke="currentColor" 
                      strokeWidth="2" 
                      strokeLinecap="round" 
                      strokeLinejoin="round"
                    >
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              );
            })}

            {caseChanges.map((change, index) => {
              const isPriorityChange = 'oldPriority' in change;
              
              return (
                <div 
                  key={`case-${index}`}
                  className="mb-2 last:mb-0 p-2 bg-gray-50 rounded text-xs border border-gray-200 flex justify-between items-start gap-2"
                >
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <svg 
                        width="14" 
                        height="14" 
                        viewBox="0 0 24 24" 
                        fill="none" 
                        stroke="currentColor" 
                        strokeWidth="2" 
                        strokeLinecap="round" 
                        strokeLinejoin="round"
                        className="text-gray-600"
                      >
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                      </svg>
                      <div className="font-semibold text-gray-800">
                        {change.casePostcode}
                      </div>
                    </div>
                    
                    {isPriorityChange ? (
                      <div>
                        <div className="text-[10px] text-gray-500 mb-0.5">Priority</div>
                        <div className="flex items-center gap-2">
                          <span className="font-medium text-gray-800">
                            {PRIORITY_LABELS[(change as PriorityChange).oldPriority]}
                          </span>
                          <span className="text-gray-400">‚Üí</span>
                          <span className="font-medium text-gray-800">
                            {PRIORITY_LABELS[(change as PriorityChange).newPriority]}
                          </span>
                        </div>
                      </div>
                    ) : (
                      <div>
                        <div className="text-[10px] text-gray-500 mb-0.5">Delivery Slot</div>
                        <div className="flex items-center gap-2">
                          <span className="font-medium text-gray-800">
                            {(change as TimeSlotChange).oldSlot 
                              ? `${(change as TimeSlotChange).oldSlot!.startTime}-${(change as TimeSlotChange).oldSlot!.endTime}`
                              : 'None'
                            }
                          </span>
                          <span className="text-gray-400">‚Üí</span>
                          <span className="font-medium text-gray-800">
                            {(change as TimeSlotChange).newSlot 
                              ? `${(change as TimeSlotChange).newSlot!.startTime}-${(change as TimeSlotChange).newSlot!.endTime}`
                              : 'None'
                            }
                          </span>
                        </div>
                      </div>
                    )}
                    
                    <div className="text-gray-500 text-[10px] mt-1">
                      {change.timestamp.toLocaleTimeString()}
                    </div>
                  </div>
                  
                  <button
                    onClick={() => onDeleteCaseChange(change.caseId, isPriorityChange ? 'priority' : 'slot')}
                    disabled={isRecalculating}
                    className={`shrink-0 flex items-center gap-1 text-[10px] rounded border-none transition-colors p-1.5 ${
                      isRecalculating
                        ? 'text-gray-300 cursor-not-allowed bg-transparent'
                        : 'text-gray-500 hover:text-gray-700 cursor-pointer bg-transparent'
                    }`}
                    title={isRecalculating ? 'Cannot delete while recalculating' : 'Restore original value'}
                  >
                    <span>Delete</span>
                    <svg 
                      width="12" 
                      height="12" 
                      viewBox="0 0 24 24" 
                      fill="none" 
                      stroke="currentColor" 
                      strokeWidth="2" 
                      strokeLinecap="round" 
                      strokeLinejoin="round"
                    >
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              );
            })}
          </div>
        </div>
      )}

      <div className="p-3 shrink-0">
        <button
          onClick={onRecalculate}
          disabled={isRecalculating}
          className={`w-full px-4 py-3 text-base font-semibold border-none rounded cursor-pointer ${
            isRecalculating
              ? 'bg-gray-400 text-white cursor-not-allowed'
              : 'bg-emerald-500 text-white hover:bg-emerald-600'
          }`}
        >
          {isRecalculating ? '‚óê Recalculating Routes...' : '‚Üª Recalculate Routes'}
        </button>
      </div>
    </div>
  );
};

import React from 'react';

export const Header: React.FC = () => {
  return (
    <>
      {/* Header with Logo and Title */}
      <div className="flex items-center gap-2 px-5 py-4 shrink-0">
        <img 
          src="/A2BLogo.png" 
          alt="A2B Logo" 
          className="h-[40px] w-auto"
        />
        <h1 className="m-0 text-2xl font-semibold text-gray-800">
          Case Manager
        </h1>
      </div>
      
      {/* Full Width Border */}
      <div className="border-b border-gray-300 shrink-0" />
    </>
  );
};

// components/RouteDetails.tsx
import React, { useState, useMemo, useEffect } from 'react';
import type { OptimizedRoute, CaseData, CasePriority, CaseChange, TimeSlot, AgentSettings, AgentChange } from '../types/route';
import { AgentCard } from './AgentCard';
import { CaseCard } from './CaseCard';
import { ChangesPanel } from './ChangesPanel';

interface RouteDetailsProps {
  routes: OptimizedRoute[];
  cases: CaseData[];
  agentSettings: AgentSettings[];
  onPriorityChange: (caseId: string, priority: CasePriority) => void;
  onSlotChange: (caseId: string, slot: TimeSlot | undefined) => void;
  onAgentSettingsChange: (agentIndex: number, settings: AgentSettings) => void;
  caseChanges: CaseChange[];
  agentChanges: AgentChange[];
  onRecalculate: () => void;
  onDeleteCaseChange: (caseId: string, changeType: 'priority' | 'slot') => void;
  onDeleteAgentChange: (agentIndex: number) => void;
  isRecalculating: boolean;
  onUnallocatedCasesUpdate?: (cases: Array<CaseData & { unallocatedNumber: number }>) => void;
}

const ROUTE_COLORS = [
  '#4285f4',
  '#ea4335',
  '#fbbc04',
  '#34a853',
  '#ff6d00',
  '#9c27b0',
  '#00bcd4',
  '#e91e63',
];

type ViewMode = 'agents' | 'cases';
type CaseFilter = 'all' | 'allocated' | 'unallocated';
type AgentFilter = 'all' | 'active' | 'inactive';

export const RouteDetails: React.FC<RouteDetailsProps> = ({
  routes,
  cases,
  agentSettings,
  onPriorityChange,
  onSlotChange,
  onAgentSettingsChange,
  caseChanges,
  agentChanges,
  onRecalculate,
  onDeleteCaseChange,
  onDeleteAgentChange,
  isRecalculating,
  onUnallocatedCasesUpdate,
}) => {
  const [viewMode, setViewMode] = useState<ViewMode>('agents');
  const [caseFilter, setCaseFilter] = useState<CaseFilter>('all');
  const [agentFilter, setAgentFilter] = useState<AgentFilter>('all');
  const [changesExpanded, setChangesExpanded] = useState(false);

  const getTimeInSeconds = (time: string | { seconds: number } | undefined): number => {
    if (!time) return Infinity;
    if (typeof time === 'object' && 'seconds' in time) {
      return time.seconds;
    }
    if (typeof time === 'string') {
      const date = new Date(time);
      return date.getTime() / 1000;
    }
    return Infinity;
  };

  const getOptimizedAgentStatus = (agentIndex: number): boolean => {
    const agentChange = agentChanges.find(change => change.agentIndex === agentIndex);
    if (agentChange) {
      return agentChange.oldSettings.active;
    }
    return agentSettings[agentIndex].active;
  };

  const unallocatedCasesWithNumbers = useMemo(() => {
    const unallocated = cases.filter(c => c.assignedAgentIndex === null);
    unallocated.sort((a, b) => a.id.localeCompare(b.id));
    
    const numbered = unallocated.map((caseData, index) => ({
      ...caseData,
      unallocatedNumber: index + 1,
    }));

    console.log('üìã RouteDetails - Created unallocated cases:', numbered.length);
    numbered.forEach(c => {
      console.log(`  - ${c.postcode} (#${c.unallocatedNumber}) - Has location: ${!!c.location}`);
    });

    return numbered;
  }, [cases]);

  useEffect(() => {
    if (onUnallocatedCasesUpdate) {
      console.log('üì§ RouteDetails - Sending unallocated cases to parent:', unallocatedCasesWithNumbers.length);
      onUnallocatedCasesUpdate(unallocatedCasesWithNumbers);
    }
  }, [unallocatedCasesWithNumbers, onUnallocatedCasesUpdate]);

  const unallocatedNumberMap = useMemo(() => {
    const map = new Map<string, number>();
    unallocatedCasesWithNumbers.forEach(c => {
      map.set(c.id, c.unallocatedNumber);
    });
    return map;
  }, [unallocatedCasesWithNumbers]);

  const filteredAgents = useMemo(() => {
    const agentsWithIndex = routes.map((route, index) => ({
      route,
      index,
      optimizedActive: getOptimizedAgentStatus(index),
    }));

    let filtered = agentsWithIndex;
    if (agentFilter === 'active') {
      filtered = agentsWithIndex.filter(a => a.optimizedActive);
    } else if (agentFilter === 'inactive') {
      filtered = agentsWithIndex.filter(a => !a.optimizedActive);
    }

    return filtered;
  }, [routes, agentSettings, agentChanges, agentFilter]);

  const agentCounts = useMemo(() => {
    const active = routes.filter((_, index) => getOptimizedAgentStatus(index)).length;
    const inactive = routes.length - active;
    return {
      all: routes.length,
      active,
      inactive,
    };
  }, [routes, agentSettings, agentChanges]);

  const filteredAndSortedCases = useMemo(() => {
    let filtered = cases;
    if (caseFilter === 'allocated') {
      filtered = cases.filter(c => c.assignedAgentIndex !== null);
    } else if (caseFilter === 'unallocated') {
      filtered = cases.filter(c => c.assignedAgentIndex === null);
    }

    return filtered.sort((a, b) => {
      const aAllocated = a.assignedAgentIndex !== null;
      const bAllocated = b.assignedAgentIndex !== null;

      if (aAllocated && !bAllocated) return -1;
      if (!aAllocated && bAllocated) return 1;

      if (aAllocated && bAllocated) {
        const agentA = a.assignedAgentIndex!;
        const agentB = b.assignedAgentIndex!;
        if (agentA !== agentB) {
          return agentA - agentB;
        }

        const timeA = getTimeInSeconds(a.deliveryTime);
        const timeB = getTimeInSeconds(b.deliveryTime);
        return timeA - timeB;
      }

      const numA = unallocatedNumberMap.get(a.id) ?? Infinity;
      const numB = unallocatedNumberMap.get(b.id) ?? Infinity;
      return numA - numB;
    });
  }, [cases, caseFilter, unallocatedNumberMap]);

  const caseCounts = useMemo(() => {
    const allocated = cases.filter(c => c.assignedAgentIndex !== null).length;
    const unallocated = cases.filter(c => c.assignedAgentIndex === null).length;
    return {
      all: cases.length,
      allocated,
      unallocated,
    };
  }, [cases]);

  const handleViewModeChange = (mode: ViewMode) => {
    setViewMode(mode);
    setChangesExpanded(false);
  };

  const handleAgentFilterChange = (filter: AgentFilter) => {
    setAgentFilter(filter);
    setChangesExpanded(false);
  };

  const handleCaseFilterChange = (filter: CaseFilter) => {
    setCaseFilter(filter);
    setChangesExpanded(false);
  };

  const totalChanges = caseChanges.length + agentChanges.length;
  const shouldShowChangesPanel = totalChanges > 0 || isRecalculating;

  useEffect(() => {
    if (!shouldShowChangesPanel && changesExpanded) {
      setChangesExpanded(false);
    }
  }, [shouldShowChangesPanel, changesExpanded]);

  if (routes.length === 0 && cases.length === 0) return null;

  return (
    <div className="flex flex-col h-full">
      <div className="shrink-0 p-4 border-b border-gray-200 bg-white">
        <div className="flex gap-2 mb-4">
          <button
            onClick={() => handleViewModeChange('agents')}
            className={`flex-1 px-4 py-2 text-sm font-semibold border-none rounded cursor-pointer transition-colors flex items-center justify-center gap-2 ${
              viewMode === 'agents'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
            }`}
          >
            <svg 
              width="16" 
              height="16" 
              viewBox="0 0 24 24" 
              fill="currentColor"
            >
              <circle cx="12" cy="7" r="5.5" />
              <path d="M2 22 Q 2 15, 6 12.5 L 18 12.5 Q 22 15, 22 22 Z" />
            </svg>
            <span>Agents</span>
          </button>
          <button
            onClick={() => handleViewModeChange('cases')}
            className={`flex-1 px-4 py-2 text-sm font-semibold border-none rounded cursor-pointer transition-colors flex items-center justify-center gap-2 ${
              viewMode === 'cases'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
            }`}
          >
            <svg 
              width="16" 
              height="16" 
              viewBox="0 0 24 24" 
              fill="none" 
              stroke="currentColor" 
              strokeWidth="2" 
              strokeLinecap="round" 
              strokeLinejoin="round"
            >
              <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
            <span>Cases</span>
          </button>
        </div>

        {viewMode === 'agents' && (
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">
              Filter Agents
            </label>
            <select
              value={agentFilter}
              onChange={(e) => handleAgentFilterChange(e.target.value as AgentFilter)}
              className="w-full text-sm border border-gray-300 rounded px-3 py-2 bg-white cursor-pointer"
            >
              <option value="all">All Agents ({agentCounts.all})</option>
              <option value="active">Active Only ({agentCounts.active})</option>
              <option value="inactive">Inactive Only ({agentCounts.inactive})</option>
            </select>
          </div>
        )}

        {viewMode === 'cases' && (
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">
              Filter Cases
            </label>
            <select
              value={caseFilter}
              onChange={(e) => handleCaseFilterChange(e.target.value as CaseFilter)}
              className="w-full text-sm border border-gray-300 rounded px-3 py-2 bg-white cursor-pointer"
            >
              <option value="all">All Cases ({caseCounts.all})</option>
              <option value="allocated">Allocated Only ({caseCounts.allocated})</option>
              <option value="unallocated">Unallocated Only ({caseCounts.unallocated})</option>
            </select>
          </div>
        )}
      </div>

      {!changesExpanded && (
        <div className="flex-1 min-h-0 overflow-y-auto p-4">
          {viewMode === 'agents' ? (
            <div className="space-y-4">
              {filteredAgents.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No agents match the current filter
                </div>
              ) : (
                filteredAgents.map(({ route, index }) => (
                  <AgentCard
                    key={`agent-${index}`}
                    route={route}
                    index={index}
                    color={ROUTE_COLORS[index % ROUTE_COLORS.length]}
                    settings={agentSettings[index]}
                    cases={cases}
                    onSettingsChange={onAgentSettingsChange}
                    onPriorityChange={onPriorityChange}
                    onSlotChange={onSlotChange}
                  />
                ))
              )}
            </div>
          ) : (
            <div className="space-y-4">
              {filteredAndSortedCases.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No cases match the current filter
                </div>
              ) : (
                filteredAndSortedCases.map((caseData) => {
                  let agentLabel: string | null = null;
                  let agentColor = '#9ca3af';
                  let routeNumber: number | null = null;
                  let unallocatedNumber: number | null = null;

                  if (caseData.assignedAgentIndex !== null) {
                    const route = routes[caseData.assignedAgentIndex];
                    if (route) {
                      agentLabel = route.vehicleLabel.replace('Vehicle', 'Agent');
                      agentColor = ROUTE_COLORS[caseData.assignedAgentIndex % ROUTE_COLORS.length];

                      const visitIndex = route.visits.findIndex(visit => {
                        return visit.shipmentLabel === caseData.postcode;
                      });

                      if (visitIndex >= 0) {
                        routeNumber = visitIndex + 1;
                      }
                    }
                  } else {
                    unallocatedNumber = unallocatedNumberMap.get(caseData.id) ?? null;
                  }

                  return (
                    <CaseCard
                      key={caseData.id}
                      caseData={caseData}
                      agentLabel={agentLabel}
                      agentColor={agentColor}
                      routeNumber={routeNumber}
                      unallocatedNumber={unallocatedNumber}
                      onPriorityChange={onPriorityChange}
                      onSlotChange={onSlotChange}
                    />
                  );
                })
              )}
            </div>
          )}
        </div>
      )}

      {shouldShowChangesPanel && (
        <div className={changesExpanded ? "flex-1 min-h-0 bg-white" : "bg-white shrink-0"}>
          <ChangesPanel
            caseChanges={caseChanges}
            agentChanges={agentChanges}
            onRecalculate={onRecalculate}
            onDeleteCaseChange={onDeleteCaseChange}
            onDeleteAgentChange={onDeleteAgentChange}
            isRecalculating={isRecalculating}
            isExpanded={changesExpanded}
            onToggleExpanded={setChangesExpanded}
          />
        </div>
      )}
    </div>
  );
};

// RouteMap.tsx - FIXED: Agent marker rendering now properly aligned
import React, { useState, useEffect, useRef } from 'react';
import { GoogleMap, Marker, Polyline, InfoWindow, OverlayView } from '@react-google-maps/api';
import type { Location, OptimizedRoute, CaseData, AgentSettings, CasePriority, TimeSlot } from '../types/route';
import { formatTime } from '../utils/formatters';

interface RouteMapProps {
  routes: OptimizedRoute[];
  agentLocations: Location[];
  cases: CaseData[];
  unallocatedCases?: Array<CaseData & { unallocatedNumber: number }>;
  routesVersion?: number;
  agentSettings: AgentSettings[];
  originalCasePriorities: Map<string, { priority: CasePriority; deliverySlot?: TimeSlot }>;
}

const mapContainerStyle = {
  width: '100%',
  height: '100%',
};

const defaultCenter = {
  lat: 51.5074,
  lng: -0.1278,
};

const mapStyles: google.maps.MapTypeStyle[] = [
  {
    featureType: 'poi.business',
    stylers: [{ visibility: 'off' }]
  },
  {
    featureType: 'poi',
    elementType: 'labels',
    stylers: [{ visibility: 'off' }]
  },
  {
    featureType: 'transit',
    elementType: 'labels',
    stylers: [{ visibility: 'off' }]
  },
  {
    featureType: 'road',
    elementType: 'labels.icon',
    stylers: [{ visibility: 'off' }]
  },
  {
    featureType: 'landscape',
    elementType: 'geometry',
    stylers: [{ color: '#e8f4f8' }]
  },
  {
    featureType: 'water',
    elementType: 'geometry',
    stylers: [{ color: '#b8d4e8' }]
  },
  {
    featureType: 'road',
    elementType: 'geometry',
    stylers: [{ color: '#ffffff' }]
  },
  {
    featureType: 'road.highway',
    elementType: 'geometry',
    stylers: [{ color: '#fff4cc' }]
  },
  {
    featureType: 'poi.park',
    elementType: 'geometry',
    stylers: [{ color: '#c8e6c9' }]
  },
  {
    featureType: 'all',
    elementType: 'labels.text.fill',
    stylers: [{ color: '#5f6368' }]
  }
];

const ROUTE_COLORS = [
  '#4285f4',
  '#ea4335',
  '#fbbc04',
  '#34a853',
  '#ff6d00',
  '#9c27b0',
  '#00bcd4',
  '#e91e63',
];

const createAgentMarkerIcon = (color: string): google.maps.Icon => {
  const svg = `
    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
      <g transform="translate(20, 21) scale(0.8)">
        <path d="M-6 -8 A 6 6 0 1 1 6 -8 A 6 6 0 1 1 -6 -8 Z" fill="white"/>
        <path d="M -10 8 Q -10 0, -6 -2 L 6 -2 Q 10 0, 10 8 Z" fill="white"/>
      </g>
    </svg>
  `;
  
  return {
    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
    scaledSize: new google.maps.Size(40, 40),
    anchor: new google.maps.Point(20, 20),
  };
};

const createFinishMarkerIcon = (color: string): google.maps.Icon => {
  const svg = `
    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
      <g transform="translate(21.5, 20) scale(0.75)">
        <rect x="-10" y="-8" width="1.5" height="18" fill="white"/>
        <g transform="translate(-9, -8)">
          <rect x="0" y="0" width="4" height="3" fill="white"/>
          <rect x="4" y="0" width="4" height="3" fill="#333"/>
          <rect x="8" y="0" width="4" height="3" fill="white"/>
          <rect x="12" y="0" width="4" height="3" fill="#333"/>
          <rect x="0" y="3" width="4" height="3" fill="#333"/>
          <rect x="4" y="3" width="4" height="3" fill="white"/>
          <rect x="8" y="3" width="4" height="3" fill="#333"/>
          <rect x="12" y="3" width="4" height="3" fill="white"/>
          <rect x="0" y="6" width="4" height="3" fill="white"/>
          <rect x="4" y="6" width="4" height="3" fill="#333"/>
          <rect x="8" y="6" width="4" height="3" fill="white"/>
          <rect x="12" y="6" width="4" height="3" fill="#333"/>
          <rect x="0" y="9" width="4" height="3" fill="#333"/>
          <rect x="4" y="9" width="4" height="3" fill="white"/>
          <rect x="8" y="9" width="4" height="3" fill="#333"/>
          <rect x="12" y="9" width="4" height="3" fill="white"/>
        </g>
      </g>
    </svg>
  `;
  
  return {
    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
    scaledSize: new google.maps.Size(40, 40),
    anchor: new google.maps.Point(20, 20),
  };
};

export const RouteMap: React.FC<RouteMapProps> = ({ 
  routes, 
  agentLocations,
  cases,
  unallocatedCases = [],
  routesVersion = 0,
  agentSettings,
  originalCasePriorities,
}) => {
  const [selectedMarker, setSelectedMarker] = useState<{
    type: 'allocated' | 'unallocated';
    routeIndex?: number;
    visitIndex?: number;
    caseId?: string;
  } | null>(null);

  const mapRef = useRef<google.maps.Map | null>(null);

  useEffect(() => {
    const timer = setTimeout(() => {
      if (!mapRef.current) return;

      const bounds = new google.maps.LatLngBounds();
      let hasPoints = false;

      // ‚úÖ FIXED: Iterate over routes to maintain proper alignment with agentSettings
      routes.forEach((route, index) => {
        const settings = agentSettings[index];
        const defaultLocation = agentLocations[index];
        const startLocation = settings?.startLocation || defaultLocation;
        
        if (startLocation) {
          bounds.extend({ lat: startLocation.latitude, lng: startLocation.longitude });
          hasPoints = true;
        }
      });

      agentSettings.forEach(settings => {
        if (settings.finishLocation) {
          bounds.extend({ 
            lat: settings.finishLocation.latitude, 
            lng: settings.finishLocation.longitude 
          });
          hasPoints = true;
        }
      });

      routes.forEach(route => {
        route.visits.forEach(visit => {
          if (visit.arrivalLocation) {
            bounds.extend({ 
              lat: visit.arrivalLocation.latitude, 
              lng: visit.arrivalLocation.longitude 
            });
            hasPoints = true;
          }
        });
      });

      unallocatedCases.forEach(caseData => {
        if (caseData.location) {
          bounds.extend({ 
            lat: caseData.location.latitude, 
            lng: caseData.location.longitude 
          });
          hasPoints = true;
        }
      });

      if (hasPoints) {
        mapRef.current.fitBounds(bounds, {
          top: 50,
          bottom: 50,
          left: 50,
          right: 50,
        });
      }
    }, 100);

    return () => clearTimeout(timer);
  }, [routes, agentLocations, unallocatedCases, routesVersion, agentSettings]);

  const getRoutePath = (route: OptimizedRoute, agentLocation: Location, agentIndex: number) => {
    const path = [];

    // ‚úÖ Use custom start location if available
    const settings = agentSettings[agentIndex];
    const startLocation = settings?.startLocation || agentLocation;

    if (startLocation) {
      path.push({
        lat: startLocation.latitude,
        lng: startLocation.longitude,
      });
    }

    route.visits.forEach(visit => {
      if (visit.arrivalLocation) {
        path.push({
          lat: visit.arrivalLocation.latitude,
          lng: visit.arrivalLocation.longitude,
        });
      }
    });

    const finishLocation = settings?.finishLocation;
    const endLocation = finishLocation || startLocation;
    
    if (endLocation) {
      path.push({
        lat: endLocation.latitude,
        lng: endLocation.longitude,
      });
    }

    return path;
  };

  const getPolylineKey = (index: number) => {
    return `polyline-${index}-v${routesVersion}`;
  };

  const getCasePriority = (postcode: string): string => {
    const caseData = cases.find(c => c.postcode === postcode);
    if (!caseData) return 'normal';
    
    // Use original priority from last optimization, not current priority with pending changes
    const originalData = originalCasePriorities.get(caseData.id);
    return originalData?.priority || caseData.priority;
  };

  const unallocatedMarkers = unallocatedCases
    .filter(caseData => !!caseData.location)
    .map((caseData) => {
      const isSelected =
        selectedMarker?.type === 'unallocated' &&
        selectedMarker?.caseId === caseData.id;

      // Use original priority from last optimization
      const originalData = originalCasePriorities.get(caseData.id);
      const displayPriority = originalData?.priority || caseData.priority;
      const isHighPriority = displayPriority === 'high';

      return (
        <React.Fragment key={`unallocated-${caseData.id}`}>
          <Marker
            position={{
              lat: caseData.location!.latitude,
              lng: caseData.location!.longitude,
            }}
            label={{
              text: String(caseData.unallocatedNumber),
              color: '#ffffff',
              fontSize: '12px',
              fontWeight: 'bold',
            }}
            icon={{
              path: google.maps.SymbolPath.CIRCLE,
              scale: isHighPriority ? 13 : 10,
              fillColor: '#6b7280',
              fillOpacity: 0.9,
              strokeColor: '#ffffff',
              strokeWeight: isHighPriority ? 4 : 2,
            }}
            onClick={() => setSelectedMarker({ type: 'unallocated', caseId: caseData.id })}
            zIndex={isHighPriority ? 1000 : 100}
          />
          {isHighPriority && (
            <OverlayView
              position={{
                lat: caseData.location!.latitude,
                lng: caseData.location!.longitude,
              }}
              mapPaneName={OverlayView.OVERLAY_MOUSE_TARGET}
            >
              <div
                style={{
                  position: 'absolute',
                  transform: 'translate(-50%, -50%)',
                  pointerEvents: 'none',
                }}
              >
                <div
                  style={{
                    position: 'absolute',
                    top: '-18px',
                    right: '-18px',
                    width: '16px',
                    height: '16px',
                    backgroundColor: '#dc2626',
                    borderRadius: '50%',
                    border: '2px solid white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '10px',
                    fontWeight: 'bold',
                    color: 'white',
                  }}
                >
                  !
                </div>
              </div>
            </OverlayView>
          )}
          {isSelected && (
            <InfoWindow
              position={{
                lat: caseData.location!.latitude,
                lng: caseData.location!.longitude,
              }}
              onCloseClick={() => setSelectedMarker(null)}
            >
              <div>
                <div>Unallocated Case</div>
                <div>
                  Case {caseData.unallocatedNumber}: {caseData.postcode}
                </div>
                <div>Priority: {displayPriority.toUpperCase()}</div>
              </div>
            </InfoWindow>
          )}
        </React.Fragment>
      );
    });

  return (
    <GoogleMap
      key={`map-v${routesVersion}`}
      mapContainerStyle={mapContainerStyle}
      center={defaultCenter}
      zoom={11}
      onLoad={(map) => {
        mapRef.current = map;
      }}
      options={{
        styles: mapStyles,
        zoomControl: true,
        streetViewControl: false,
        mapTypeControl: false,
        fullscreenControl: true,
        disableDefaultUI: false,
      }}
    >
      {/* Agent Start Markers - FIXED: Now iterates over routes to maintain alignment */}
      {routes.map((route, index) => {
        const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
        const settings = agentSettings[index];
        const defaultLocation = agentLocations[index];
        
        // ‚úÖ Use custom start location from settings if available, otherwise use default
        const startLocation = settings?.startLocation || defaultLocation;
        
        if (!startLocation) return null;
        
        return (
          <Marker
            key={`agent-start-${index}`}
            position={{
              lat: startLocation.latitude,
              lng: startLocation.longitude,
            }}
            icon={createAgentMarkerIcon(color)}
            title={`Agent ${index + 1} Start${settings?.startPostcode ? ` (${settings.startPostcode})` : ''}`}
            zIndex={50}
          />
        );
      })}

      {/* Agent Finish Markers */}
      {agentSettings.map((settings, index) => {
        if (!settings.finishLocation) return null;
        
        const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
        return (
          <Marker
            key={`agent-finish-${index}`}
            position={{
              lat: settings.finishLocation.latitude,
              lng: settings.finishLocation.longitude,
            }}
            icon={createFinishMarkerIcon(color)}
            title={`Agent ${index + 1} Finish`}
            zIndex={50}
          />
        );
      })}

      {/* Case Location Markers for all routes */}
      {routes.map((route, routeIndex) =>
        route.visits.map((visit, visitIndex) => {
          if (!visit.arrivalLocation) return null;

          const color = ROUTE_COLORS[routeIndex % ROUTE_COLORS.length];
          const isSelected =
            selectedMarker?.type === 'allocated' &&
            selectedMarker?.routeIndex === routeIndex &&
            selectedMarker?.visitIndex === visitIndex;

          const isHighPriority = getCasePriority(visit.shipmentLabel) === 'high';

          return (
            <React.Fragment key={`visit-${routeIndex}-${visitIndex}-${visit.shipmentLabel}`}>
              <Marker
                position={{
                  lat: visit.arrivalLocation.latitude,
                  lng: visit.arrivalLocation.longitude,
                }}
                label={{
                  text: String(visitIndex + 1),
                  color: '#ffffff',
                  fontSize: '12px',
                  fontWeight: 'bold',
                }}
                icon={{
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: isHighPriority ? 13 : 10,
                  fillColor: color,
                  fillOpacity: 0.9,
                  strokeColor: '#ffffff',
                  strokeWeight: isHighPriority ? 4 : 2,
                }}
                onClick={() => setSelectedMarker({ type: 'allocated', routeIndex, visitIndex })}
                zIndex={isHighPriority ? 1000 : 100}
              />
              {isHighPriority && (
                <OverlayView
                  position={{
                    lat: visit.arrivalLocation.latitude,
                    lng: visit.arrivalLocation.longitude,
                  }}
                  mapPaneName={OverlayView.OVERLAY_MOUSE_TARGET}
                >
                  <div
                    style={{
                      position: 'absolute',
                      transform: 'translate(-50%, -50%)',
                      pointerEvents: 'none',
                    }}
                  >
                    <div
                      style={{
                        position: 'absolute',
                        top: '-18px',
                        right: '-18px',
                        width: '16px',
                        height: '16px',
                        backgroundColor: '#dc2626',
                        borderRadius: '50%',
                        border: '2px solid white',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '10px',
                        fontWeight: 'bold',
                        color: 'white',
                      }}
                    >
                      !
                    </div>
                  </div>
                </OverlayView>
              )}
              {isSelected && (
                <InfoWindow
                  position={{
                    lat: visit.arrivalLocation.latitude,
                    lng: visit.arrivalLocation.longitude,
                  }}
                  onCloseClick={() => setSelectedMarker(null)}
                >
                  <div>
                    <div>{route.vehicleLabel}</div>
                    <div>
                      Case {visitIndex + 1}: {visit.shipmentLabel}
                    </div>
                    {formatTime(visit.startTime) && (
                      <div>Arrival: {formatTime(visit.startTime)}</div>
                    )}
                  </div>
                </InfoWindow>
              )}
            </React.Fragment>
          );
        })
      )}

      {/* Unallocated Case Markers */}
      {unallocatedMarkers}

      {/* Route Polylines for all agents */}
      {routes.map((route, index) => {
        if (!agentLocations[index] || route.visits.length === 0) return null;

        const path = getRoutePath(route, agentLocations[index], index);
        if (path.length < 2) return null;

        return (
          <Polyline
            key={getPolylineKey(index)}
            path={path}
            options={{
              strokeColor: ROUTE_COLORS[index % ROUTE_COLORS.length],
              strokeWeight: 3,
              strokeOpacity: 0.7,
            }}
          />
        );
      })}
    </GoogleMap>
  );
};

import React, { useState } from 'react';
import type { TimeSlot } from '../types/route';
import { generateTimeOptions } from '../utils/timeSlotGenerator';

interface TimeSlotInputProps {
  caseId: string;
  deliverySlot?: TimeSlot;
  onSlotChange: (caseId: string, slot: TimeSlot | undefined) => void;
}

export const TimeSlotInput: React.FC<TimeSlotInputProps> = ({
  caseId,
  deliverySlot,
  onSlotChange,
}) => {
  const [showInput, setShowInput] = useState(!!deliverySlot);
  const timeOptions = generateTimeOptions();

  const handleAddSlot = () => {
    setShowInput(true);
    // Set default slot to 9am-5pm
    onSlotChange(caseId, {
      startTime: '09:00',
      endTime: '17:00',
    });
  };

  const handleRemoveSlot = () => {
    setShowInput(false);
    onSlotChange(caseId, undefined);
  };

  const handleStartTimeChange = (newStartTime: string) => {
    if (deliverySlot) {
      onSlotChange(caseId, {
        ...deliverySlot,
        startTime: newStartTime,
      });
    }
  };

  const handleEndTimeChange = (newEndTime: string) => {
    if (deliverySlot) {
      onSlotChange(caseId, {
        ...deliverySlot,
        endTime: newEndTime,
      });
    }
  };

  if (!showInput) {
    return (
      <div className="mb-2">
        <label className="block text-xs font-medium text-gray-600 mb-1">
          Time Slot
        </label>
        <button
          onClick={handleAddSlot}
          className="text-xs text-blue-600 hover:text-blue-700 font-medium cursor-pointer"
        >
          + Add Slot
        </button>
      </div>
    );
  }

  return (
    <div className="mb-2">
      <div className="flex items-center justify-between mb-1">
        <label className="block text-xs font-medium text-gray-600">
          Time Slot
        </label>
<button
  onClick={handleRemoveSlot}
  className="flex items-center gap-1 text-[10px] text-gray-500 hover:text-gray-700 cursor-pointer"
>
  <span>Remove</span>
  <svg 
    width="12" 
    height="12" 
    viewBox="0 0 24 24" 
    fill="none" 
    stroke="currentColor" 
    strokeWidth="2" 
    strokeLinecap="round" 
    strokeLinejoin="round"
  >
    <path d="M3 6h18"></path>
    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
  </svg>
</button>
      </div>
      <div className="flex items-center gap-2">
        <select
          value={deliverySlot?.startTime}
          onChange={(e) => handleStartTimeChange(e.target.value)}
          className="flex-1 text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer"
        >
          {timeOptions.map((time) => (
            <option key={time} value={time}>
              {time}
            </option>
          ))}
        </select>
        <div className="w-8 text-center text-xs text-gray-500">-</div>
        <select
          value={deliverySlot?.endTime}
          onChange={(e) => handleEndTimeChange(e.target.value)}
          className="flex-1 text-xs border border-gray-300 rounded px-2 py-1 bg-white cursor-pointer"
        >
          {timeOptions.map((time) => (
            <option key={time} value={time}>
              {time}
            </option>
          ))}
        </select>
      </div>
    </div>
  );
};


// FRONTEND - types

// types/route.ts - UPDATED

export interface Location {
  latitude: number;
  longitude: number;
}

export interface Visit {
  shipmentIndex: number;
  shipmentLabel: string;
  startTime: string | { seconds: number };
  arrivalLocation?: Location;
}

export interface RouteMetrics {
  travelDuration: string | { seconds: number };
  travelDistance: number;
}

export interface OptimizedRoute {
  vehicleLabel: string;
  visits: Visit[];
  metrics: RouteMetrics;
}

// ‚úÖ UPDATED: Changed from 'low' | 'medium' | 'high' to 'normal' | 'high'
export type CasePriority = 'normal' | 'high';

export type CaseStatus = 'pending' | 'complete';

export interface TimeSlot {
  startTime: string; // Format: "HH:mm"
  endTime: string;   // Format: "HH:mm"
}

export interface CaseData {
  id: string;
  postcode: string;
  location?: Location;
  priority: CasePriority;
  status: CaseStatus;
  assignedAgentIndex: number | null;
  deliveryTime?: string | { seconds: number };
  deliverySlot?: TimeSlot;
}

export interface PriorityChange {
  caseId: string;
  casePostcode: string;
  oldPriority: CasePriority;
  newPriority: CasePriority;
  timestamp: Date;
}

export interface TimeSlotChange {
  caseId: string;
  casePostcode: string;
  oldSlot: TimeSlot | undefined;
  newSlot: TimeSlot | undefined;
  timestamp: Date;
}

export type CaseChange = PriorityChange | TimeSlotChange;

export interface AgentSettings {
  startTime: string; // "HH:mm"
  endTime: string;   // "HH:mm"
  lunchDuration: number; // minutes
  active: boolean; // whether agent is active or inactive
  startPostcode?: string; // Optional custom start location (overrides default)
  startLocation?: Location; // Geocoded start coordinates
  finishPostcode?: string; // Optional different finish location
  finishLocation?: Location; // Geocoded finish coordinates
}


export interface AgentChange {
  agentIndex: number;
  agentLabel: string;
  oldSettings: AgentSettings;
  newSettings: AgentSettings;
  timestamp: Date;
}

export type Change = CaseChange | AgentChange;

export interface ScenarioConfig {
  name: string;
  description: string;
  caseCount: number;
  agentPostcodes: string[];
  defaultStartTime: string;
  defaultEndTime: string;
  defaultLunchDuration: number;
  agentFinishPostcodes?: (string | undefined)[];
}

export type ScenarioType = 'full' | 'reduced';


// FRONTEND - utils

// utils/caseGenerator.ts - UPDATED

import type { CasePriority } from '../types/route';

/**
 * Generate a random priority with distribution:
 * - 1/6 high priority (approximately 17% of cases)
 * - 5/6 normal priority (approximately 83% of cases)
 * 
 * ‚úÖ UPDATED: Changed from three-tier (low/medium/high) to two-tier (normal/high)
 */
export const generateCasePriority = (): CasePriority => {
  const random = Math.random();
  
  // 1 in 6 cases are high priority
  if (random < 1/3) {
    return 'high';
  } else {
    return 'normal';
  }
};

export const formatDuration = (duration: string | { seconds: number } | any): string => {
  if (duration && typeof duration === 'object' && 'seconds' in duration) {
    const seconds = duration.seconds;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    if (minutes > 0) {
      return `${minutes}m ${remainingSeconds}s`;
    }
    return `${seconds}s`;
  }
  
  if (typeof duration === 'string') {
    const match = duration.match(/(\d+)s/);
    if (match) {
      const seconds = parseInt(match[1]);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
      }
      return `${seconds}s`;
    }
    return duration;
  }
  
  return '0s';
};

export const formatTime = (timestamp: string | { seconds: number } | any): string => {
  try {
    if (timestamp && typeof timestamp === 'object' && 'seconds' in timestamp) {
      const date = new Date(timestamp.seconds * 1000);
      return date.toLocaleTimeString();
    }
    
    if (typeof timestamp === 'string') {
      const date = new Date(timestamp);
      if (!isNaN(date.getTime())) {
        return date.toLocaleTimeString();
      }
    }
    
    return '';
  } catch (error) {
    console.error('Error formatting time:', error);
    return '';
  }
};

export const formatTimeWithoutSeconds = (timestamp: string | { seconds: number } | any): string => {
  try {
    let seconds: number;
    
    if (timestamp && typeof timestamp === 'object' && 'seconds' in timestamp) {
      seconds = typeof timestamp.seconds === 'string' 
        ? parseInt(timestamp.seconds) 
        : timestamp.seconds;
    } else if (typeof timestamp === 'string') {
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
      });
    } else {
      return '';
    }
    
    // Convert seconds since midnight to HH:MM
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
  } catch (error) {
    console.error('Error formatting time:', error);
    return '';
  }
};

/**
 * Normalize UK postcode format for comparison
 * Removes spaces and converts to uppercase
 */
const normalizePostcode = (postcode: string): string => {
  return postcode.replace(/\s+/g, '').toUpperCase();
};

/**
 * Check if the geocoded result matches the input postcode
 */
const isValidPostcodeMatch = (inputPostcode: string, geocodedAddress: string): boolean => {
  const normalizedInput = normalizePostcode(inputPostcode);
  const normalizedGeocoded = normalizePostcode(geocodedAddress);
  
  // Check if the geocoded address contains the input postcode
  // This handles cases where Google returns "SW1A 1AA, Westminster, London, UK"
  return normalizedGeocoded.includes(normalizedInput);
};

/**
 * Validate UK postcode format (basic check)
 */
const isValidUKPostcodeFormat = (postcode: string): boolean => {
  // UK postcode regex: https://en.wikipedia.org/wiki/Postcodes_in_the_United_Kingdom#Validation
  const ukPostcodeRegex = /^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i;
  return ukPostcodeRegex.test(postcode.trim());
};

/**
 * Geocode a postcode to coordinates using Google Maps Geocoding API
 * Now with validation to prevent accepting gibberish
 */
export const geocodePostcode = async (postcode: string): Promise<{ latitude: number; longitude: number } | null> => {
  try {
    // Step 1: Basic format validation
    if (!isValidUKPostcodeFormat(postcode)) {
      console.warn(`Invalid UK postcode format: ${postcode}`);
      return null;
    }

    const geocoder = new google.maps.Geocoder();
    
    // Step 2: Try geocoding with just the postcode first (without ", London, UK")
    let result = await geocoder.geocode({
      address: postcode,
      region: 'UK',
      componentRestrictions: {
        country: 'UK',
      },
    });

    // Step 3: Validate the result
    if (result.results && result.results.length > 0) {
      const firstResult = result.results[0];
      const location = firstResult.geometry.location;
      const geocodedAddress = firstResult.formatted_address;
      
      // Check if the geocoded address actually contains our postcode
      if (isValidPostcodeMatch(postcode, geocodedAddress)) {
        console.log(`‚úÖ Successfully geocoded ${postcode} to ${geocodedAddress}`);
        return {
          latitude: location.lat(),
          longitude: location.lng(),
        };
      } else {
        // The geocoder returned something, but it doesn't match our postcode
        console.warn(`‚ùå Geocoded address "${geocodedAddress}" doesn't match input "${postcode}"`);
        return null;
      }
    }
    
    console.warn(`‚ùå No results found for postcode: ${postcode}`);
    return null;
  } catch (error) {
    console.error(`Failed to geocode ${postcode}:`, error);
    return null;
  }
};

/**
 * Geocode multiple postcodes in batches to avoid rate limits
 */
export const geocodePostcodes = async (
  postcodes: string[],
  onProgress?: (completed: number, total: number) => void
): Promise<Map<string, { latitude: number; longitude: number }>> => {
  const results = new Map<string, { latitude: number; longitude: number }>();
  const batchSize = 10; // Process 10 at a time
  const delayMs = 200; // Delay between batches to avoid rate limits

  for (let i = 0; i < postcodes.length; i += batchSize) {
    const batch = postcodes.slice(i, i + batchSize);
    
    // Process batch in parallel
    const batchResults = await Promise.all(
      batch.map(async (postcode) => {
        const coords = await geocodePostcode(postcode);
        return { postcode, coords };
      })
    );

    // Store results
    batchResults.forEach(({ postcode, coords }) => {
      if (coords) {
        results.set(postcode, coords);
      }
    });

    // Report progress
    if (onProgress) {
      onProgress(Math.min(i + batchSize, postcodes.length), postcodes.length);
    }

    // Delay before next batch (except for last batch)
    if (i + batchSize < postcodes.length) {
      await new Promise(resolve => setTimeout(resolve, delayMs));
    }
  }

  return results;
};



const LONDON_POSTCODES = [
"WC2H 7BX","EC1M 5PW","E1 4QL","E2 6QA","E3 3HP","E3 5DP",
  "N1 7GU","N5 1NU","NW1 6XE","NW3 6HU","NW8 7NB","SE1 7QD","SE11 4BT","SE26 4HG","SW1W 9SU","W1C 2JL",
  "W8 6DW","WC1N 3LJ","EC4A 3LT","EC4M 8EB","E14 4LX","E14 8QS","N1 1TR","N4 2BE","NW1 5JB","NW5 2PB",
  "SE1 3BP","SE6 2PR","SE23 1HT","SW1P 3JA","W1G 8LZ","W10 4LG","WC1X 9EU","WC2R 1BT","EC3M 7AA","E1 3DZ",
  "E2 1BQ","E5 0SE","E15 2SE","N1 2AA","N10 1PY","NW2 4TP","NW8 8RH","SE1 2AE","SE15 3UX","SW1A 1QD",
  "SW3 2EF","W1H 5HF","W2 6AA","WC1R 0NP","WC2E 6JJ","EC1V 8QT","E1W 2SW","E14 2AN","N4 1AP","NW3 1HL",
  "SE1 1TD","SE9 2JL","SW1X 0AA","W1J 4QU","W6 7NF","WC1E 6HR","EC4N 7BP","E1 5DL","E3 1ET","N7 6QP",
  "N16 0RQ","NW1 6AB","NW5 3HA","SE1 0NY","SE15 2EH","SW6 1LR","W1T 1AJ","W2 2UH","WC2B 6EX","EC3A 7DP",
    "BR1 1AA", "BR2 9EF", "BR3 3NH", "BR5 1AJ", "BR6 0RL", "BR7 5AB",
  "CR0 1AA", "CR2 6AQ", "CR4 7AL", "CR7 8BD", "CR8 2BN", "CR9 1AT",
  "DA1 4AL", "DA5 1AA", "DA6 7AY", "DA14 4AS", "DA15 7DW", "DA16 1BW",
  "E4 6AG", "E6 1AA", "E10 5HH", "E11 1AA", "E12 5DB", "E17 3AA", "E18 1AA",
  "EN1 1AA", "EN2 6AA", "EN3 4AA", "EN4 8AA", "EN5 1AA",
  "HA0 1AA", "HA1 1AA", "HA2 0AA", "HA3 5AA", "HA5 1AA", "HA8 0AA", "HA9 0AA",
  "IG1 1AA", "IG2 6AA", "IG3 8AA", "IG6 1AA", "IG8 0AA", "IG11 7AA",
  "KT1 1AA", "KT2 5AA", "KT3 3AA", "KT4 7AA", "KT6 4AA", "KT9 1AA",
  "N3 1AA", "N9 0AA", "N11 1AA", "N12 0AA", "N13 4AA", "N14 5AA", "N20 0AA", "N21 1AA",
  "NW2 1AA", "NW4 1AA", "NW7 1AA", "NW9 0AA", "NW10 1AA",
  "RM1 1AA", "RM2 5AA", "RM3 0AA", "RM6 4AA", "RM8 1AA", "RM11 1AA", "RM12 4AA",
  "SE2 0AA", "SE3 0AA", "SE6 1AA", "SE9 1AA", "SE12 0AA", "SE18 1AA", "SE20 7AA", "SE25 4AA",
  "SM1 1AA", "SM2 5AA", "SM3 8AA", "SM4 4AA", "SM5 1AA", "SM6 0AA",
  "SW14 7AA", "SW15 1AA", "SW16 1AA", "SW17 0AA", "SW19 1AA", "SW20 0AA",
  "TW1 1AA", "TW3 1AA", "TW5 0AA", "TW7 4AA", "TW9 1AA", "TW13 4AA",
  "UB1 1AA", "UB2 4AA", "UB3 1AA", "UB5 4AA", "UB6 0AA", "UB8 1AA", "UB10 0AA",
  "W3 0AA", "W4 1AA", "W5 1AA", "W7 1AA", "W13 0AA",

  // Enfield / Barnet (EN, N outer)
  "EN1 1AA","EN1 2JP","EN2 6RT","EN3 5HX","EN4 8QF","EN5 4DL","EN6 1AB","EN7 6QR",
  "N11 1QG","N11 2AB","N12 0JP","N13 4RD","N14 6QA","N20 9DB",

  // Harrow / Brent / Wembley (HA)
  "HA0 1AA","HA0 4TX","HA1 1BQ","HA1 4FH","HA2 6AB","HA2 9RS","HA3 5UX","HA3 8NP",
  "HA4 0DR","HA4 9QD","HA5 1RF","HA5 3LL","HA6 1NW","HA6 2YY",

  // Hillingdon / Uxbridge / Hayes (UB)
  "UB1 1AF","UB2 3QP","UB3 4AZ","UB4 8RN","UB5 6HJ","UB6 0FD","UB7 9DP",
  "UB8 1QS","UB9 6AD","UB10 0XY","UB11 1AA",

  // Ealing / West London outer (W)
  "W3 7AB","W4 5RP","W5 3HT","W7 2AJ","W13 0DH",

  // Hounslow / Twickenham (TW)
  "TW1 1AE","TW1 4HF","TW2 5NB","TW3 3AT","TW4 6QS","TW5 0PL","TW7 7DX",
  "TW8 9DF","TW9 1UJ","TW10 5NG","TW11 9LR","TW12 2AB","TW13 6RT","TW14 0QA",

  // Kingston / Surbiton (KT)
  "KT1 1AA","KT1 3JP","KT2 5TN","KT3 6RF","KT4 8BQ","KT5 9LP","KT6 4DN",
  "KT7 0XH","KT8 1QS","KT9 2AB",

  // Bromley / Orpington (BR)
  "BR1 1AB","BR1 3JP","BR2 0AA","BR3 4HQ","BR4 9DX","BR5 1LL",
  "BR6 7QS","BR7 5NP","BR8 8QA",

  // Croydon (CR)
  "CR0 1AA","CR0 4AB","CR2 6JP","CR3 5TN","CR4 1XG",
  "CR5 2AD","CR6 9PL","CR7 8HX","CR8 3QS","CR9 2AJ",

  // Bexley / Dartford (DA)
  "DA1 1AA","DA2 6JP","DA3 7TN","DA4 9QS","DA5 1AB",
  "DA6 8HQ","DA7 5RF","DA8 3LL","DA9 9DX",

  // Havering / Romford (RM)
  "RM1 1AA","RM1 4JP","RM2 5TN","RM3 8AB","RM4 1QS",
  "RM5 3DX","RM6 6HQ","RM7 9RF","RM8 2LL","RM9 5NP",
  "RM10 7AB","RM11 3JP","RM12 4TN","RM13 8QS","RM14 1DX",

  // Redbridge / Ilford (IG)
  "IG1 1AA","IG1 4JP","IG2 6TN","IG3 8AB","IG4 5QS",
  "IG5 0DX","IG6 2HQ","IG7 9RF","IG8 1LL","IG9 6NP",

  // Outer East London (E)
  "E4 6AA","E6 1JP","E7 0TN","E10 5AB","E11 3QS",
  "E12 6DX","E13 9HQ","E15 2RF","E17 1LL","E18 5NP",

  // Outer South East London (SE)
  "SE2 0AA","SE3 9JP","SE6 4TN","SE7 8AB","SE9 1QS",
  "SE12 0DX","SE13 6HQ","SE18 2RF","SE19 1LL","SE20 7NP",

  // Outer South West London (SW)
  "SW12 9AA","SW13 0JP","SW15 3TN","SW16 6AB",
  "SW17 8QS","SW18 4DX","SW19 1HQ","SW20 9RF"
];

export interface PostcodeCase {
  postcode: string;
}

/**
 * Randomly select unique postcodes from the real London postcodes array
 * Each postcode will only be used once (no duplicates)
 */
export const generateMultiplePostcodes = (count: number): PostcodeCase[] => {
  if (count > LONDON_POSTCODES.length) {
    console.warn(`‚ö†Ô∏è  Requested ${count} postcodes but only ${LONDON_POSTCODES.length} unique postcodes available. Will use all available.`);
    count = LONDON_POSTCODES.length;
  }
  
  // Create a copy of the postcodes array and shuffle it
  const shuffledPostcodes = [...LONDON_POSTCODES];
  
  // Fisher-Yates shuffle algorithm
  for (let i = shuffledPostcodes.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledPostcodes[i], shuffledPostcodes[j]] = [shuffledPostcodes[j], shuffledPostcodes[i]];
  }
  
  // Take the first 'count' postcodes (all unique)
  return shuffledPostcodes.slice(0, count).map(postcode => ({ postcode }));
};

/**
 * Get a random postcode for agent locations
 */
export const getRandomPostcode = (): string => {
  const randomIndex = Math.floor(Math.random() * LONDON_POSTCODES.length);
  return LONDON_POSTCODES[randomIndex];
};

/**
 * Convert time string (e.g., "09:00") to seconds since midnight
 */
export const timeToSeconds = (timeString: string): number => {
  const [hours, minutes] = timeString.split(':').map(Number);
  return hours * 3600 + minutes * 60;
};

/**
 * Get time window for 9am-5pm shift
 */
export const getShiftTimeWindow = () => {
  return {
    startTime: { seconds: timeToSeconds('09:00') },
    endTime: { seconds: timeToSeconds('17:00') },
  };
};

/**
 * Get lunch break constraint (45 minutes)
 */
export const getLunchBreakConstraint = () => {
  return {
    startTime: { seconds: timeToSeconds('12:00') },
    duration: { seconds: 45 * 60 }, // 45 minutes
  };
};

// utils/priorityMapping.ts - UPDATED

import type { CasePriority } from '../types/route';

/**
 * Map case priority to penalty cost for route optimization
 * Penalty cost represents the "cost" of NOT completing this delivery
 * Higher priority = higher cost to skip = more likely to be included
 * 
 * ‚úÖ UPDATED: Two-tier system with 5:1 ratio
 * - Normal: ¬£100 (baseline cost for standard deliveries)
 * - High: ¬£500 (5x multiplier for urgent/priority deliveries)
 */
export const getPenaltyCost = (priority: CasePriority): number => {
  switch (priority) {
    case 'high':
      return 500; // High cost to skip high-priority cases
    case 'normal':
      return 100; // Baseline cost for normal cases
    default:
      return 100;
  }
};

/**
 * Get display label for penalty cost
 */
export const getPenaltyCostLabel = (priority: CasePriority): string => {
  const cost = getPenaltyCost(priority);
  return `¬£${cost}`;
};

// utils/timeSlotGenerator.ts
import type { TimeSlot } from '../types/route';

/**
 * Generate a random time in HH:mm format with 15-minute increments between 9am-5pm
 */
const generateRandomTimeIncrements = (): string => {
  // Generate hours between 9-16 (9am-4:45pm to allow for 15-min window)
  const minHour = 9;
  const maxHour = 16; // Up to 4:45pm so end time can be 5pm
  const hours = minHour + Math.floor(Math.random() * (maxHour - minHour + 1));
  
  // Generate minutes in 15-minute increments (0, 15, 30, 45)
  const minutes = Math.floor(Math.random() * 4) * 15;
  
  // Make sure we don't go past 4:45pm
  if (hours === 16 && minutes === 45) {
    // If we hit 4:45pm, ensure end time won't exceed 5pm
    return '16:30'; // Return 4:30pm instead
  }
  
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
};

/**
 * Generate a random delivery time slot (15-minute window) between 9am-5pm
 * Returns undefined for cases that don't need a slot (11 out of 12)
 */
export const generateDeliverySlot = (): TimeSlot | undefined => {
  // 1 in 12 cases should have a delivery slot
  if (Math.random() > 1/3) {
    return undefined;
  }
  
  // Generate a random start time between 9am-4:45pm
  const startTime = generateRandomTimeIncrements();
  
  // End time is 15 minutes after start time
  const [startHours, startMinutes] = startTime.split(':').map(Number);
  let endMinutes = startMinutes + 15;
  let endHours = startHours;
  
  if (endMinutes >= 60) {
    endMinutes -= 60;
    endHours += 1;
  }
  
  const endTime = `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
  
  return {
    startTime,
    endTime,
  };
};

/**
 * Generate array of time options in 15-minute increments
 * @param extended - If true, range is 7am-8pm. If false, range is 9am-5pm
 */
export const generateTimeOptions = (extended: boolean = false): string[] => {
  const options: string[] = [];
  
  const startHour = extended ? 7 : 9;
  const endHour = extended ? 20 : 17;
  
  for (let hours = startHour; hours <= endHour; hours++) {
    for (let minutes = 0; minutes < 60; minutes += 15) {
      // Don't add times after end hour
      if (hours === endHour && minutes > 0) {
        break;
      }
      
      const time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      options.push(time);
    }
  }
  
  return options;
};

/**
 * Generate lunch duration options from 0 to 120 minutes in 15-minute increments
 */
export const generateLunchOptions = (): Array<{ value: number; label: string }> => {
  const options: Array<{ value: number; label: string }> = [];
  
  for (let minutes = 0; minutes <= 120; minutes += 15) {
    let label: string;
    
    if (minutes === 0) {
      label = 'No lunch break';
    } else if (minutes === 60) {
      label = '1 hour';
    } else if (minutes > 60) {
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      if (remainingMinutes === 0) {
        label = `${hours} hours`;
      } else {
        label = `${hours}h ${remainingMinutes}min`;
      }
    } else {
      label = `${minutes} min`;
    }
    
    options.push({ value: minutes, label });
  }
  
  return options;
};

/**
 * Convert time string (HH:mm) to seconds since midnight
 */
export const timeStringToSeconds = (time: string): number => {
  const [hours, minutes] = time.split(':').map(Number);
  return hours * 3600 + minutes * 60;
};